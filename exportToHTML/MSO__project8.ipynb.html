<html>
<head>
<title>MSO__project8.ipynb</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #969896;}
.s1 { color: #333333;}
.s2 { color: #a71d5d;}
.s3 { color: #63a35c;}
.s4 { color: #008080; font-weight: bold;}
.s5 { color: #0086b3;}
.s6 { color: #183691;}
.ls0 { height: 1px; border-width: 0; color: #c0c0c0; background-color:#c0c0c0}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
MSO__project8.ipynb</font>
</center></td></tr></table>
<pre><span class="s0">#%% md 
</span>
<span class="s1">&lt;center&gt; 
     
# Modelling, Simulation and Optimisation Project 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">&lt;center&gt; 
    &lt;i&gt;&lt;b&gt;SUBMITTED BY:&lt;/b&gt; 
 
&lt;font color=blue&gt; 
 
&lt;center&gt;Sobil Dalal&lt;br&gt;  
&lt;center&gt;School of Computing&lt;br&gt;  
&lt;center&gt;National College of Ireland&lt;br&gt; 
&lt;center&gt;Dublin, Ireland&lt;br&gt; 
&lt;center&gt;x19148496@student.ncirl.ie&lt;/i&gt; 
 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1"># Problem 
 
&lt;b&gt;The Context:&lt;/b&gt; 
 
- A high-speed train as planned for the HS2 line from London to Birmingham has a maximum acceleration of 0.76m/s2, about the same as a commuter train. While the trains can brake in an emergency at 2.5m/s2, the energy optimal deceleration (using regenerative braking) is 0.38m/s2. 
- The maximum travelling speed of the train is about 310km/h (86.1m/s). For the purpose of this project we will ignore the impact of air resistance. That means we assume a constant acceleration up to maximum speed. Accelerating from 0 to the maximum speed takes therefore 113.3s during which time the train travels about 4,878m. 
- A railway line consists of a sequence of signaling blocks. A train is only allowed to enter a block, when there is no other train in the block and the entry signal is green. When a train enters a block the entry signal switches to red. The entrance signal switches back to green 5 seconds after the end of the train has left the block. 
- We assume for the purpose of this project that the signalling blocks have all equal length. Depending on the speed of a train it requires a number of free blocks ahead of it, to maintain the current speed. This speed is determined so that the train is guaranteed to stop safely before a red signal. 
- This results in a trade-off. When the speed of the train is slower, it is possible to have more trains on the track, as there are less free blocks required between the trains. The faster a train the more free blocks are required in front of the train to continue maintaining the high speed. 
- Given a number of blocks along a track there will be an optimal point for the number of trains per hour that could be run on the track at full speed. 
- The control problem is to keep the trains moving at maximum possible safe speed. If there is a slight delay in one train it may cause the train in the following block to decelerate potentially down to stop and then to reaccelerate, which in turn will delay the train thereafter. Just like the “traffic jam” effect you know from the motorway. A train can run constantly at full speed if there is always at least the required number of free blocks ahead. 
 
&lt;b&gt;Part 1 Simulation:&lt;/b&gt; 
 
- Create a simulation for the London Old Oak Commons to Birmingham Interchange section of the high-speed line. The distance between London Old Oak Common Station and Birmingham Interchange Station is 145km. Assume that the track consists of k signalling blocks of equal length and that a fixed train schedule of n trains per hour is to be used. 
- Verify the simulation model by inducing a temporary break down due to electrical malfunction of the 9am train from London to Birmingham. It takes 30 minutes to fix the problem. 
- To reflect operational conditions introduce variability of travelling times using a suitable distribution on events. You can choose the distribution and the parameters as you deem appropriate. It may be useful to consider two types of variations: normal deviations (of just a few minutes for example caused by common weather events or delays in departure due to passenger movements), and rare events with bigger impact (like heavy rain or technical problems) that may impact also on later trains. Yuxiang Yang et al [1] report a log-normal distribution with μ= 3.378 and σ=0.751 for the delay times (in minutes( on a segment of a comparable Chinese high-speed train (including the knock-on effect on the following trains). 
 
&lt;b&gt;Part 2 Optimisation:&lt;/b&gt; 
 
- For given parameters k and n create a train schedule that sets out the departure and arrival time for trains with the first train leaving at 7am and the last train leaving at 10pm. Using the simulation created in part 1 report the distribution of actual delay times. The aim is to maximise the number of trains operating per hour under the constraint that the average delay time should not be higher than half the scheduled time between consecutive trains. Report your recommendation for the layout of the track (k) and the schedule (n). 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">## Learning from the problem 
 
### Train properties are: 
&lt;ol&gt; 
  &lt;li&gt;Max acceleration = 0.76 m/$s^{2}$&lt;/li&gt; 
  &lt;li&gt;Emergency deceleration = 2.5 m/$s^{2}$&lt;/li&gt; 
  &lt;li&gt;Normal deceleration = 0.38 m/$s^{2}$&lt;/li&gt; 
  &lt;li&gt;Max speed = 86.1 m/s&lt;/li&gt; 
 
  Assumption from the question: Air resistance is ignored. 
    &lt;font color=green&gt; 
  &lt;li&gt;Time to achieve max speed = tA = 113.3 s&lt;/li&gt; 
  &lt;li&gt;Distance covered to achieve max speed = dA = 4,878 m&lt;/li&gt; 
&lt;/ol&gt; 
 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">### Signalling blocks properties are: 
&lt;ol&gt; 
  &lt;li&gt;Size = equal&lt;/li&gt; 
  &lt;li&gt;Dwell time = 5s&lt;/li&gt; 
&lt;/ol&gt; 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">### Stations properties from London Old Oak Commons to Birmingham Interchangeare are: 
&lt;ol&gt; 
  &lt;li&gt;Distance = 145 km = 1,45,000 m&lt;/li&gt; 
    &lt;font color=green&gt; 
  &lt;li&gt;Number of trains per hour = n = ?&lt;/li&gt; 
  &lt;li&gt;Number of signalling blocks between stations = k = ?&lt;/li&gt; 
&lt;/ol&gt; 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">### Incident properties are: 
&lt;ol&gt; 
  &lt;li&gt;Duration = 30 min = 1800s&lt;/li&gt; 
  &lt;li&gt;Start time = 9am&lt;/li&gt; 
&lt;/ol&gt; 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">### Travelling time variablilty: 
&lt;ol&gt; 
  &lt;li&gt;Can be due to movement of passengers&lt;/li&gt; 
  &lt;li&gt;Can be due to weather.&lt;/li&gt; 
&lt;/ol&gt; 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">## Assumptions from the question 
 
- Impact of air resistance is ignored and that means a constant acceleration up to maximum speed. 
- The signalling blocks have all equal length. 
- Yuxiang Yang et al [1] report a log-normal distribution with μ= 3.378 and σ=0.751 for the delay times (in minutes( on a segment of a comparable Chinese high-speed train (including the knock-on effect on the following trains) 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">## Load Libraries and Plotting Routines 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">import </span><span class="s1">pandas </span><span class="s2">as </span><span class="s1">pd</span>
<span class="s2">import </span><span class="s1">matplotlib </span><span class="s2">as </span><span class="s1">mpl</span>
<span class="s2">import </span><span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">pyplot </span><span class="s2">as </span><span class="s1">plt</span>
<span class="s2">import </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats </span><span class="s2">as </span><span class="s1">stats</span>
<span class="s2">import </span><span class="s1">math</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">statsmodels</span><span class="s3">.</span><span class="s1">api </span><span class="s2">as </span><span class="s1">sm</span>
<span class="s2">import </span><span class="s1">pulp</span>
<span class="s2">import </span><span class="s1">simpy</span>
<span class="s2">import </span><span class="s1">random</span>
<span class="s2">import </span><span class="s1">time</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">linear_model </span><span class="s2">import </span><span class="s1">LinearRegression</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">optimize </span><span class="s2">import </span><span class="s1">linprog</span>
<span class="s1">plt</span><span class="s3">.</span><span class="s1">rcParams</span><span class="s3">.</span><span class="s1">update</span><span class="s3">({</span><span class="s4">'figure.max_open_warning'</span><span class="s2">: </span><span class="s5">0</span><span class="s3">})</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">plot</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">xmin</span><span class="s3">, </span><span class="s1">xmax</span><span class="s3">, </span><span class="s1">pdf</span><span class="s2">=None</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=None</span><span class="s3">, </span>
         <span class="s1">μ</span><span class="s2">=None</span><span class="s3">, </span><span class="s1">σ</span><span class="s2">=None</span><span class="s3">,</span>
         
         <span class="s1">title</span><span class="s2">=None</span><span class="s3">, </span><span class="s1">xlabel</span><span class="s2">=None</span><span class="s3">, </span><span class="s1">ylabel</span><span class="s2">=None</span><span class="s3">)</span><span class="s2">:</span>
    
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s3">.</span><span class="s1">figure</span><span class="s3">()</span>
    <span class="s1">fig</span><span class="s3">.</span><span class="s1">set_figwidth</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)</span>
    <span class="s1">fig</span><span class="s3">.</span><span class="s1">set_figheight</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">gca</span><span class="s3">()</span>
    
    <span class="s1">μ </span><span class="s2">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
    <span class="s1">σ </span><span class="s2">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)  </span>
    <span class="s1">minx </span><span class="s2">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
    <span class="s1">maxx </span><span class="s2">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        
    <span class="s1">ax</span><span class="s3">.</span><span class="s1">set_xlim</span><span class="s3">(</span><span class="s1">xmin</span><span class="s3">, </span><span class="s1">xmax</span><span class="s3">)</span>
    
    <span class="s2">if </span><span class="s1">title</span><span class="s2">!=None:</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">title</span><span class="s3">(</span><span class="s1">title</span><span class="s3">)</span>
        
    <span class="s1">plt</span><span class="s3">.</span><span class="s1">hist</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">bins</span><span class="s3">, </span><span class="s1">density</span><span class="s2">=True</span><span class="s3">)</span>
    
    <span class="s0"># calculate parameter for text positioning</span>
    <span class="s1">dx</span><span class="s2">=</span><span class="s3">(</span><span class="s1">xmax</span><span class="s2">-</span><span class="s1">xmin</span><span class="s3">)</span><span class="s2">*</span><span class="s5">0.02</span>
    <span class="s1">ymin</span><span class="s3">, </span><span class="s1">ymax</span><span class="s2">=</span><span class="s1">plt</span><span class="s3">.</span><span class="s1">ylim</span><span class="s3">()</span>
    <span class="s1">ypos</span><span class="s2">=</span><span class="s1">ymin</span><span class="s2">+</span><span class="s5">0.9</span><span class="s2">*</span><span class="s3">(</span><span class="s1">ymax</span><span class="s2">-</span><span class="s1">ymin</span><span class="s3">)</span>
     
    <span class="s0"># plot the probability density function if one is given</span>
    <span class="s2">if </span><span class="s1">pdf</span><span class="s2">!=None:</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s1">xmin</span><span class="s3">, </span><span class="s1">xmax</span><span class="s3">, </span><span class="s5">100</span><span class="s3">))</span>
        <span class="s1">Y </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">X</span><span class="s3">]</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">plot</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'red'</span><span class="s3">)</span>
 
    <span class="s1">ax</span><span class="s3">.</span><span class="s1">axvline</span><span class="s3">(</span><span class="s1">x</span><span class="s2">=</span><span class="s1">μ</span><span class="s3">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'red'</span><span class="s3">, </span><span class="s1">linestyle</span><span class="s2">=</span><span class="s4">'dashed'</span><span class="s3">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">plt</span><span class="s3">.</span><span class="s1">text</span><span class="s3">(</span><span class="s1">μ</span><span class="s2">+</span><span class="s1">dx</span><span class="s3">, </span><span class="s1">ypos</span><span class="s3">, </span><span class="s4">f&quot;μ=</span><span class="s6">{</span><span class="s1">μ</span><span class="s6">:</span><span class="s4">3.2f</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'red'</span><span class="s3">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s5">14</span><span class="s3">)</span>
    
    <span class="s1">ax</span><span class="s3">.</span><span class="s1">axvline</span><span class="s3">(</span><span class="s1">x</span><span class="s2">=</span><span class="s1">minx</span><span class="s3">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'red'</span><span class="s3">, </span><span class="s1">linestyle</span><span class="s2">=</span><span class="s4">':'</span><span class="s3">)</span>
    <span class="s1">ax</span><span class="s3">.</span><span class="s1">axvline</span><span class="s3">(</span><span class="s1">x</span><span class="s2">=</span><span class="s1">maxx</span><span class="s3">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'red'</span><span class="s3">, </span><span class="s1">linestyle</span><span class="s2">=</span><span class="s4">':'</span><span class="s3">)</span>

        
    <span class="s1">plt</span><span class="s3">.</span><span class="s1">grid</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">poissonPlot</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">pdf</span><span class="s2">=None</span><span class="s3">, </span><span class="s1">title</span><span class="s2">=None</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s1">μ </span><span class="s2">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">()</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">count</span><span class="s3">()</span>
    <span class="s1">max </span><span class="s2">= </span><span class="s1">math</span><span class="s3">.</span><span class="s1">ceil</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">max</span><span class="s3">()</span><span class="s2">/</span><span class="s5">10</span><span class="s3">)</span><span class="s2">*</span><span class="s5">10</span>
    
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s3">.</span><span class="s1">figure</span><span class="s3">()</span>
    <span class="s1">fig</span><span class="s3">.</span><span class="s1">set_figwidth</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)</span>
    <span class="s1">fig</span><span class="s3">.</span><span class="s1">set_figheight</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
    
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s3">.</span><span class="s1">gca</span><span class="s3">()</span>
    <span class="s1">ax</span><span class="s3">.</span><span class="s1">set_xlim</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">max</span><span class="s3">)</span>
    
    <span class="s2">if </span><span class="s1">title</span><span class="s2">!=None:</span>
        <span class="s1">ax</span><span class="s3">.</span><span class="s1">set_title</span><span class="s3">(</span><span class="s1">title</span><span class="s2">+</span><span class="s4">&quot; (n={:,})&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">n</span><span class="s3">))</span>
        
    <span class="s1">data</span><span class="s3">.</span><span class="s1">hist</span><span class="s3">(</span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">max</span><span class="s2">+</span><span class="s5">1 </span><span class="s2">if </span><span class="s1">max</span><span class="s2">&lt;</span><span class="s5">100 </span><span class="s2">else </span><span class="s5">100</span><span class="s3">, </span><span class="s1">density</span><span class="s2">=True</span><span class="s3">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">i</span><span class="s2">/</span><span class="s5">10 </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">10</span><span class="s2">*</span><span class="s1">max</span><span class="s3">)]</span>

    <span class="s2">if </span><span class="s1">pdf </span><span class="s2">is None:</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s3">[ </span><span class="s5">1</span><span class="s2">/</span><span class="s1">μ</span><span class="s2">*</span><span class="s1">math</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s2">-</span><span class="s1">x</span><span class="s2">/</span><span class="s1">μ</span><span class="s3">) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">x</span><span class="s3">]</span>
    <span class="s2">else:</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">x</span><span class="s3">]</span>
    <span class="s1">plt</span><span class="s3">.</span><span class="s1">plot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s5">3</span><span class="s3">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'red'</span><span class="s3">)</span>
    <span class="s1">ax</span><span class="s3">.</span><span class="s1">axvline</span><span class="s3">(</span><span class="s1">x</span><span class="s2">=</span><span class="s1">μ</span><span class="s3">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'red'</span><span class="s3">)</span>
    <span class="s1">plt</span><span class="s3">.</span><span class="s1">text</span><span class="s3">(</span><span class="s1">μ</span><span class="s2">+</span><span class="s5">0.2</span><span class="s3">,</span><span class="s5">0.9</span><span class="s2">*</span><span class="s1">y</span><span class="s3">[</span><span class="s5">0</span><span class="s3">],</span><span class="s4">'μ='</span><span class="s2">+</span><span class="s4">'%2.2f' </span><span class="s2">% </span><span class="s1">μ</span><span class="s3">, </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'red'</span><span class="s3">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s5">14</span><span class="s3">)</span>
    <span class="s1">plt</span><span class="s3">.</span><span class="s1">grid</span><span class="s3">(</span><span class="s2">True</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">plotWithPdf</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">xmin</span><span class="s3">, </span><span class="s1">xmax</span><span class="s3">, </span><span class="s1">pdf</span><span class="s2">=None</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=None</span><span class="s3">, </span>
         <span class="s1">μ</span><span class="s2">=None</span><span class="s3">, </span><span class="s1">σ</span><span class="s2">=None</span><span class="s3">,</span>
         
         <span class="s1">title</span><span class="s2">=None</span><span class="s3">, </span><span class="s1">xlabel</span><span class="s2">=None</span><span class="s3">, </span><span class="s1">ylabel</span><span class="s2">=None</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s1">data</span><span class="s2">= </span><span class="s1">data</span>
    <span class="s1">xmin</span><span class="s2">= </span><span class="s1">xmin</span>
    <span class="s1">xmax</span><span class="s2">=</span><span class="s1">xmax</span>
    <span class="s1">pdf</span><span class="s2">=</span><span class="s1">pdf</span>
    <span class="s1">bins</span><span class="s2">=</span><span class="s1">bins</span>
    <span class="s1">μ</span><span class="s2">=</span><span class="s1">μ</span>
    <span class="s1">σ</span><span class="s2">=</span><span class="s1">σ</span>
    <span class="s1">title</span><span class="s2">=</span><span class="s1">title</span>
    <span class="s1">xlabel</span><span class="s2">=</span><span class="s1">xlabel</span>
    <span class="s1">ylabel</span><span class="s2">=</span><span class="s1">ylabel</span>
    
    <span class="s2">if </span><span class="s1">title</span><span class="s2">==None:</span>
        <span class="s1">title </span><span class="s2">= </span><span class="s4">&quot;&quot;</span>
    <span class="s2">else:</span>
        <span class="s1">title </span><span class="s2">= </span><span class="s1">title </span><span class="s2">+ </span><span class="s4">&quot; and sd =&quot;</span>
    
    <span class="s1">σ </span><span class="s2">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">std</span><span class="s3">()</span>
    <span class="s1">μ </span><span class="s2">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">()</span>
    <span class="s1">norm </span><span class="s2">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s1">μ</span><span class="s3">, </span><span class="s1">scale</span><span class="s2">=</span><span class="s1">σ</span><span class="s3">).</span><span class="s1">pdf</span>
    <span class="s1">plot</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">pdf</span><span class="s2">=</span><span class="s1">norm</span><span class="s3">, </span><span class="s1">xmin</span><span class="s2">=</span><span class="s1">xmin</span><span class="s3">, </span><span class="s1">xmax</span><span class="s2">=</span><span class="s1">xmax</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">bins</span><span class="s3">, </span><span class="s1">title</span><span class="s2">=</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">title</span><span class="s6">}{</span><span class="s1">max</span><span class="s3">((</span><span class="s1">μ</span><span class="s2">-</span><span class="s1">data</span><span class="s3">.</span><span class="s1">min</span><span class="s3">())</span><span class="s2">/</span><span class="s1">σ</span><span class="s3">,  (</span><span class="s1">data</span><span class="s3">.</span><span class="s1">max</span><span class="s3">()</span><span class="s2">-</span><span class="s1">μ</span><span class="s3">)</span><span class="s2">/</span><span class="s1">σ</span><span class="s3">)</span><span class="s6">:</span><span class="s4">3.1f</span><span class="s6">}</span><span class="s4">σ&quot;</span><span class="s3">)</span>
    <span class="s0">#print(f&quot;{max((μ-arr.min())/σ,  (arr.max()-μ)/σ):3.1f}σ&quot;)</span>
<hr class="ls0"><span class="s0">#%% md 
</span>

<span class="s1">## Prepare Data 
 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">### Calculate time taken for a train to cross each block 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">timeTo</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">acc</span><span class="s3">, </span><span class="s1">dec</span><span class="s3">, </span><span class="s1">maxV</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s0"># acc     constant acceleration, m/s²</span>
    <span class="s0"># dec     constant deceleration, m/s²</span>
    <span class="s0"># maxV    maximumum velocity, m/s</span>
    <span class="s0"># dist    distance, m</span>
    <span class="s0"># return  time in seconds required to travel</span>
    <span class="s0">#</span>
    <span class="s1">dB </span><span class="s2">= </span><span class="s1">dist</span><span class="s2">/</span><span class="s1">k</span>
    <span class="s1">tA </span><span class="s2">= </span><span class="s1">maxV</span><span class="s2">/</span><span class="s1">acc         </span><span class="s0"># time to accelerate to maxV</span>
    <span class="s1">dA </span><span class="s2">= </span><span class="s3">(</span><span class="s1">acc</span><span class="s2">*</span><span class="s1">tA</span><span class="s2">**</span><span class="s5">2</span><span class="s3">)</span><span class="s2">/</span><span class="s5">2       </span><span class="s0"># distance traveled during acceleration from 0 to maxV and back to 0</span>
    <span class="s1">tD </span><span class="s2">= </span><span class="s1">maxV</span><span class="s2">/</span><span class="s1">dec</span>
    <span class="s1">dD </span><span class="s2">= </span><span class="s3">(</span><span class="s1">dec</span><span class="s2">*</span><span class="s1">tD</span><span class="s2">**</span><span class="s5">2</span><span class="s3">)</span><span class="s2">/</span><span class="s5">2</span>
    
    <span class="s2">if </span><span class="s3">(</span><span class="s1">dB </span><span class="s2">&lt; </span><span class="s3">(</span><span class="s1">dA </span><span class="s2">+ </span><span class="s1">dD</span><span class="s3">))</span><span class="s2">:        </span><span class="s0"># train never reaches full speed?</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">2.0</span><span class="s2">*</span><span class="s1">dB</span><span class="s2">/</span><span class="s3">(</span><span class="s1">acc</span><span class="s2">*</span><span class="s5">3</span><span class="s3">)) </span><span class="s2">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">4.0</span><span class="s2">*</span><span class="s1">dB</span><span class="s2">/</span><span class="s3">(</span><span class="s1">dec</span><span class="s2">*</span><span class="s5">3</span><span class="s3">))     </span><span class="s0"># time needed to accelerate to 1/3 point then decelerate to destination</span>
    <span class="s2">else:</span>
        <span class="s2">return </span><span class="s1">tA </span><span class="s2">+ </span><span class="s1">tD </span><span class="s2">+ </span><span class="s3">(</span><span class="s1">dB</span><span class="s2">-</span><span class="s1">dA</span><span class="s2">-</span><span class="s1">dD</span><span class="s3">)</span><span class="s2">/</span><span class="s1">maxV   </span><span class="s0"># time to accelerate to maxV plus travel at maxV plus decelerate to destination</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Create a dataframe containing details of Blocks - from, to and direction 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">inputData</span><span class="s3">(</span><span class="s1">K</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s1">inputData </span><span class="s2">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">()</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">K</span><span class="s3">)</span><span class="s2">: </span>
                <span class="s1">inputData</span><span class="s3">.</span><span class="s1">at</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s4">'From'</span><span class="s3">] </span><span class="s2">= </span><span class="s4">'P' </span><span class="s2">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">i</span><span class="s2">+</span><span class="s5">1</span><span class="s3">)</span>
                <span class="s1">inputData</span><span class="s3">.</span><span class="s1">at</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s4">'To'</span><span class="s3">] </span><span class="s2">= </span><span class="s4">'P' </span><span class="s2">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">i</span><span class="s2">+</span><span class="s5">2</span><span class="s3">)</span>
                <span class="s1">inputData</span><span class="s3">.</span><span class="s1">at</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s4">'Block'</span><span class="s3">] </span><span class="s2">= </span><span class="s4">'B' </span><span class="s2">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">i</span><span class="s2">+</span><span class="s5">1</span><span class="s3">)</span>
                <span class="s1">inputData</span><span class="s3">.</span><span class="s1">at</span><span class="s3">[</span><span class="s1">i</span><span class="s3">,</span><span class="s4">'Direction'</span><span class="s3">] </span><span class="s2">= </span><span class="s4">&quot;LOND-BIRM&quot;</span>
    
    <span class="s2">return </span><span class="s1">inputData   </span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Create a dataframe with all details of Blocks 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">blockData</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">, </span><span class="s1">acc</span><span class="s3">, </span><span class="s1">dec</span><span class="s3">, </span><span class="s1">vel</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">)</span><span class="s2">:</span>
    
    <span class="s1">blockData </span><span class="s2">= </span><span class="s1">inputData</span><span class="s3">(</span><span class="s1">k</span><span class="s3">)</span>
    
    <span class="s0">#Total distance can be splitted by number of blocka</span>
    <span class="s1">dT </span><span class="s2">= </span><span class="s5">145000</span>
    <span class="s1">dB </span><span class="s2">= </span><span class="s1">dT</span><span class="s2">/</span><span class="s1">k</span>
    
    <span class="s1">blockData</span><span class="s3">[</span><span class="s4">'Distance'</span><span class="s3">] </span><span class="s2">= </span><span class="s1">dB</span>
    <span class="s1">blockData</span><span class="s3">[</span><span class="s4">'Drive Time'</span><span class="s3">] </span><span class="s2">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">timeTo</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">acc</span><span class="s3">, </span><span class="s1">dec</span><span class="s3">, </span><span class="s1">vel</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">))</span>
    <span class="s1">blockData</span><span class="s3">[</span><span class="s4">'Dwell Time'</span><span class="s3">] </span><span class="s2">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">lognormal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">,</span><span class="s1">sigma</span><span class="s3">, </span><span class="s1">size</span><span class="s2">=</span><span class="s1">k</span><span class="s3">)</span>
    <span class="s1">blockData</span><span class="s3">[</span><span class="s4">'Running Time'</span><span class="s3">] </span><span class="s2">= </span><span class="s1">blockData</span><span class="s3">[</span><span class="s4">'Dwell Time'</span><span class="s3">] </span><span class="s2">+ </span><span class="s1">blockData</span><span class="s3">[</span><span class="s4">'Drive Time'</span><span class="s3">]</span>

    <span class="s2">return </span><span class="s1">blockData</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Derived Details 
&lt;br&gt; 
&lt;br&gt; 
 
&lt;font color=green&gt; 
     
- Distance deceleration  
    &amp;emsp; 
    $$ distance_{deceleration} = \frac{Speed_{intial}^2 - Speed_{final}^2}{2*deceleration}$$ 
 
    $$ dD = \frac{86.1^2 - 0^2}{2*0.38} = 9,754.22 m$$ 
  
- Time deceleration 
    &amp;emsp; 
    $$ time_{deceleration} = \frac{Speed{intial} - Speed_{final}}{deceleration}$$ 
 
    $$ tD = \frac{86.1 - 0}{0.38} = 226.6 s$$ 
     
- Total min distance for max speed  
    &amp;emsp; 
    $$dT = dA + dD $$ 
    $$dT = 4,878 + 9,754.22 = 1,4632.22m $$ 
 
- Total min time for max speed  
    &amp;emsp; 
    $$tT = tA + tD $$ 
    $$tT = 113.3 + 226.6 = 339.9s $$ 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">### Creating signaling block data 
 
Taking the values from assumptions 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
<span class="s1">blkData </span><span class="s2">= </span><span class="s1">blockData</span><span class="s3">(</span><span class="s1">k</span><span class="s2">=</span><span class="s5">6</span><span class="s3">, </span><span class="s1">mean</span><span class="s2">=</span><span class="s5">3.378</span><span class="s3">, </span><span class="s1">sigma</span><span class="s2">=</span><span class="s5">0.751</span><span class="s3">, </span><span class="s1">acc</span><span class="s2">=</span><span class="s5">0.76</span><span class="s3">, </span><span class="s1">dec</span><span class="s2">=</span><span class="s5">0.38</span><span class="s3">, </span><span class="s1">vel</span><span class="s2">=</span><span class="s5">86.1</span><span class="s3">, </span><span class="s1">dist</span><span class="s2">=</span><span class="s5">145000 </span><span class="s3">)</span>
<span class="s1">blkData</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">## Exploratory Data Analysis 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">### Dwell Time 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">blkData</span><span class="s3">[</span><span class="s4">&quot;Dwell Time&quot;</span><span class="s3">].</span><span class="s1">min</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">blkData</span><span class="s3">[</span><span class="s4">&quot;Dwell Time&quot;</span><span class="s3">].</span><span class="s1">max</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">blkData</span><span class="s3">[</span><span class="s4">&quot;Dwell Time&quot;</span><span class="s3">].</span><span class="s1">mean</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">blkData</span><span class="s3">[</span><span class="s4">&quot;Dwell Time&quot;</span><span class="s3">].</span><span class="s1">std</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">plotWithPdf</span><span class="s3">(</span><span class="s1">blkData</span><span class="s3">[</span><span class="s4">'Dwell Time'</span><span class="s3">], </span><span class="s1">xmin</span><span class="s2">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">xmax</span><span class="s2">=</span><span class="s5">150</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">150</span><span class="s3">, </span><span class="s5">41</span><span class="s3">), </span><span class="s1">title</span><span class="s2">=</span><span class="s4">&quot;Number of blocks = 6&quot;</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Running Time 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">blkData</span><span class="s3">[</span><span class="s4">&quot;Running Time&quot;</span><span class="s3">].</span><span class="s1">min</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">blkData</span><span class="s3">[</span><span class="s4">&quot;Running Time&quot;</span><span class="s3">].</span><span class="s1">max</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">blkData</span><span class="s3">[</span><span class="s4">&quot;Running Time&quot;</span><span class="s3">].</span><span class="s1">mean</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">blkData</span><span class="s3">[</span><span class="s4">&quot;Running Time&quot;</span><span class="s3">].</span><span class="s1">std</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">plotWithPdf</span><span class="s3">(</span><span class="s1">blkData</span><span class="s3">[</span><span class="s4">&quot;Running Time&quot;</span><span class="s3">], </span><span class="s1">xmin</span><span class="s2">=</span><span class="s5">300</span><span class="s3">, </span><span class="s1">xmax</span><span class="s2">=</span><span class="s5">600</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">300</span><span class="s3">, </span><span class="s5">600</span><span class="s3">, </span><span class="s5">41</span><span class="s3">), </span><span class="s1">title</span><span class="s2">=</span><span class="s4">&quot;Number of blocks = 6&quot;</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">## Modeling 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s0"># To maintain sync</span>
<span class="s1">dt </span><span class="s2">= </span><span class="s1">blkData</span>
<span class="s1">dt</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### The Infrastructure (Stations, Depots etc) 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">The class NetworkNode is used as the common base class for all infrastructure classes. Each NetworkNode (like a station) has a name and belongs to a track, i.e. a direction. 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">#### NetworkNode 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">class </span><span class="s1">NetworkNode</span><span class="s2">:</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">location</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">location</span><span class="s2">=</span><span class="s1">location</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracing</span><span class="s2">=False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">incidents</span><span class="s2">=</span><span class="s3">[]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">arr_time</span><span class="s2">=</span><span class="s3">[]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dep_time</span><span class="s2">=</span><span class="s3">[]</span>

    <span class="s0"># is only used in connection with tracing</span>
    <span class="s2">def </span><span class="s1">setTrack</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">track</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">track</span><span class="s2">=</span><span class="s1">track</span>

    <span class="s2">def </span><span class="s1">isTracing</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracing </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">track</span><span class="s3">.</span><span class="s1">isTracing</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">trace</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracing</span><span class="s2">=True</span>

    <span class="s2">def </span><span class="s1">trace_prefix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">train</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">global </span><span class="s1">max_direction_length</span>
        <span class="s2">return </span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">now</span><span class="s3">()</span><span class="s6">:</span><span class="s4">s</span><span class="s6">} </span><span class="s4">&quot; </span><span class="s1">\</span>
               <span class="s4">f&quot;[Train </span><span class="s6">{</span><span class="s1">train</span><span class="s3">.</span><span class="s1">getNo</span><span class="s3">()</span><span class="s6">:</span><span class="s4">2d</span><span class="s6">} </span><span class="s4">&quot; </span><span class="s1">\</span>
               <span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">train</span><span class="s3">.</span><span class="s1">getDirection</span><span class="s3">()</span><span class="s6">:{</span><span class="s1">max_direction_length</span><span class="s6">}</span><span class="s4">s</span><span class="s6">}</span><span class="s4">]&quot;</span>

    <span class="s2">def </span><span class="s1">arr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">train</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">arr_time</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">env</span><span class="s3">.</span><span class="s1">now</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">isTracing</span><span class="s3">() </span><span class="s2">or </span><span class="s1">train</span><span class="s3">.</span><span class="s1">isTracing</span><span class="s3">()</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">trace_prefix</span><span class="s3">(</span><span class="s1">train</span><span class="s3">)</span><span class="s6">:</span><span class="s4">s</span><span class="s6">} </span><span class="s4">arr </span><span class="s6">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">()</span><span class="s6">:</span><span class="s4">s</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">dep</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">train</span><span class="s3">, </span><span class="s1">dest</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dep_time</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">env</span><span class="s3">.</span><span class="s1">now</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">isTracing</span><span class="s3">() </span><span class="s2">or </span><span class="s1">train</span><span class="s3">.</span><span class="s1">isTracing</span><span class="s3">()</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">trace_prefix</span><span class="s3">(</span><span class="s1">train</span><span class="s3">)</span><span class="s6">:</span><span class="s4">s</span><span class="s6">} </span><span class="s4">dep </span><span class="s6">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">()</span><span class="s6">:</span><span class="s4">s</span><span class="s6">} </span><span class="s4">for </span><span class="s6">{</span><span class="s1">dest</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">()</span><span class="s6">:</span><span class="s4">s</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">loc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">location</span>

    <span class="s2">def </span><span class="s1">__str__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">location</span>
    
    <span class="s2">def </span><span class="s1">getResource</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">pass</span>
    
    <span class="s0"># trace output for incident</span>
    <span class="s2">def </span><span class="s1">inc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">train</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">isTracing</span><span class="s3">() </span><span class="s2">or </span><span class="s1">train</span><span class="s3">.</span><span class="s1">isTracing</span><span class="s3">()</span><span class="s2">:</span>
            <span class="s1">delay</span><span class="s2">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">incidentDelay</span><span class="s3">()</span>
            <span class="s1">message</span><span class="s2">=</span><span class="s4">f&quot;expected delay </span><span class="s6">{</span><span class="s1">daytime</span><span class="s3">(</span><span class="s1">delay</span><span class="s3">)</span><span class="s6">:</span><span class="s4">s</span><span class="s6">}</span><span class="s4">&quot; </span><span class="s2">if </span><span class="s1">delay</span><span class="s2">&gt;</span><span class="s5">0 </span><span class="s2">else </span><span class="s4">&quot;incident cleared&quot;</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">trace_prefix</span><span class="s3">(</span><span class="s1">train</span><span class="s3">)</span><span class="s6">:</span><span class="s4">s</span><span class="s6">} </span><span class="s4">inc </span><span class="s6">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">()</span><span class="s6">:</span><span class="s4">s</span><span class="s6">} {</span><span class="s1">message</span><span class="s6">:</span><span class="s4">s</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)        </span>
            
    <span class="s0"># registers an incident</span>
    <span class="s2">def </span><span class="s1">registerIncident</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">incident</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">incidents</span><span class="s2">+=</span><span class="s3">[</span><span class="s1">incident</span><span class="s3">]</span>
        
    <span class="s0"># checks if there is currently an incident in progress</span>
    <span class="s0"># if yes, it returns True otherwise False</span>
    <span class="s2">def </span><span class="s1">isIncident</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">for </span><span class="s1">inc </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">incidents</span><span class="s2">:</span>
            <span class="s2">if </span><span class="s1">inc</span><span class="s3">.</span><span class="s1">active</span><span class="s3">()</span><span class="s2">:</span>
                <span class="s2">return True</span>
        <span class="s2">return False</span>
        
    <span class="s0"># if there is currently an incident in progress it returns</span>
    <span class="s0"># the time the incident will probably continue, otherwise it returns 0</span>
    <span class="s2">def </span><span class="s1">incidentDelay</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">stopTime</span><span class="s2">=</span><span class="s5">0</span>
        <span class="s2">for </span><span class="s1">incident </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">incidents</span><span class="s2">:</span>
            <span class="s2">if </span><span class="s1">incident</span><span class="s3">.</span><span class="s1">active</span><span class="s3">()</span><span class="s2">:</span>
                <span class="s1">stopTime</span><span class="s2">=</span><span class="s1">max</span><span class="s3">(</span><span class="s1">stopTime</span><span class="s3">, </span><span class="s1">incident</span><span class="s3">.</span><span class="s1">stopTime</span><span class="s3">())</span>
        <span class="s2">return </span><span class="s5">0 </span><span class="s2">if </span><span class="s1">stopTime</span><span class="s2">==</span><span class="s5">0 </span><span class="s2">else </span><span class="s1">stopTime</span><span class="s2">-</span><span class="s1">env</span><span class="s3">.</span><span class="s1">now</span>
    
    <span class="s2">def </span><span class="s1">getArrivalTimes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">arr_time</span>
    
    <span class="s2">def </span><span class="s1">getDepartureTimes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dep_time</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">#### Depots 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">A train depot serves a line and feeds trains into a particular direction. 
&lt;font color=red&gt; 
            
- Below paramter as set as global parameters 
        
- Assumed mean dwell time at station (Passenger onboarding and deboarding)= 10  
         
- Assumed mean drive time from the station to block = 20 
     
- There is no signalling block in at the depot 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">class </span><span class="s1">Depot</span><span class="s3">(</span><span class="s1">NetworkNode</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">location</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">location</span><span class="s2">+</span><span class="s4">&quot; (DEPOT)&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">direction</span><span class="s2">=</span><span class="s1">direction</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dist_drive_time </span><span class="s2">= </span><span class="s1">\</span>
        <span class="s1">stats</span><span class="s3">.</span><span class="s1">expon</span><span class="s3">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s1">depot_drive_time</span><span class="s3">, </span>
                        <span class="s1">scale</span><span class="s2">=</span><span class="s1">scale_drive</span><span class="s3">(</span><span class="s1">depot_drive_time</span><span class="s3">))</span>
        
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dwell_time </span><span class="s2">= </span><span class="s1">\</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s1">depot_dwell_time</span><span class="s3">, </span>
                       <span class="s1">scale</span><span class="s2">=</span><span class="s1">scale_dwell</span><span class="s3">(</span><span class="s1">depot_dwell_time</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">driveTime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_drive_time</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">dwellTime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">x</span><span class="s2">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dwell_time</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">x</span><span class="s2">&lt;</span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">=</span><span class="s5">1</span>
        <span class="s2">if </span><span class="s1">x</span><span class="s2">&lt;</span><span class="s5">5</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">*</span><span class="s5">3</span>
        <span class="s2">return </span><span class="s1">x</span>
    
    <span class="s2">def </span><span class="s1">dep</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">train</span><span class="s3">, </span><span class="s1">dest</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">train</span><span class="s3">.</span><span class="s1">setDirection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">direction</span><span class="s3">)</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">dep</span><span class="s3">(</span><span class="s1">train</span><span class="s3">, </span><span class="s1">dest</span><span class="s3">)</span>
        
    <span class="s2">def </span><span class="s1">getResource</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return None</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">#### Stations 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">A Station object describes a track in a physical station. Hence we use a station object for each of the directions of a line going through the station. 
 
The common name of the physical station can be accessed as `loc()`. 
 
&lt;font color=red&gt; 
            
- Below paramter as set as global parameters 
        
- Assumed mean dwell time at station (Passenger onboarding and deboarding)= 15  
         
- Assumed mean drive time from the station to block = 20 
     
- Signalling is also mainted at stations with 5s time red to green signal after train leave the station 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">scale_dwell</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s2">return </span><span class="s1">min</span><span class="s3">(</span><span class="s5">0.3</span><span class="s2">*</span><span class="s1">m</span><span class="s3">, </span><span class="s5">10</span><span class="s3">)</span>

<span class="s2">def </span><span class="s1">scale_drive</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s2">return </span><span class="s1">min</span><span class="s3">(</span><span class="s5">0.2</span><span class="s2">*</span><span class="s1">m</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s2">class </span><span class="s1">Station</span><span class="s3">(</span><span class="s1">NetworkNode</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">location</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">location</span><span class="s2">+</span><span class="s4">&quot; (Station)&quot;</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">direction</span><span class="s2">=</span><span class="s1">direction</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">resource</span><span class="s2">=</span><span class="s1">simpy</span><span class="s3">.</span><span class="s1">Resource</span><span class="s3">(</span><span class="s1">env</span><span class="s3">, </span><span class="s1">capacity</span><span class="s2">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dist_drive_time </span><span class="s2">= </span><span class="s1">\</span>
        <span class="s1">stats</span><span class="s3">.</span><span class="s1">expon</span><span class="s3">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s5">20</span><span class="s3">, </span>
                        <span class="s1">scale</span><span class="s2">=</span><span class="s1">scale_drive</span><span class="s3">(</span><span class="s1">station_drive_time</span><span class="s3">))</span>
        
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dwell_time </span><span class="s2">= </span><span class="s1">\</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s5">15</span><span class="s3">, </span>
                       <span class="s1">scale</span><span class="s2">=</span><span class="s1">scale_dwell</span><span class="s3">(</span><span class="s1">station_dwell_time</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">driveTime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_drive_time</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">dwellTime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">x</span><span class="s2">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dwell_time</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">x</span><span class="s2">&lt;</span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">=</span><span class="s5">1</span>
        <span class="s2">if </span><span class="s1">x</span><span class="s2">&lt;</span><span class="s5">5</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">*</span><span class="s5">3</span>
        <span class="s2">return </span><span class="s1">x</span>

    <span class="s2">def </span><span class="s1">dep</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">train</span><span class="s3">, </span><span class="s1">dest</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">train</span><span class="s3">.</span><span class="s1">setDirection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">direction</span><span class="s3">)</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">dep</span><span class="s3">(</span><span class="s1">train</span><span class="s3">, </span><span class="s1">dest</span><span class="s3">)</span>
    
    <span class="s2">def </span><span class="s1">getResource</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">resource</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">#### Signaling Block 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">class </span><span class="s1">Block</span><span class="s3">(</span><span class="s1">NetworkNode</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">location</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">location</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">location</span><span class="s2">=</span><span class="s1">location</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">direction</span><span class="s2">=</span><span class="s1">direction</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">resource</span><span class="s2">=</span><span class="s1">simpy</span><span class="s3">.</span><span class="s1">Resource</span><span class="s3">(</span><span class="s1">env</span><span class="s3">, </span><span class="s1">capacity</span><span class="s2">=</span><span class="s5">1</span><span class="s3">)</span>

        <span class="s1">dd</span><span class="s2">=</span><span class="s1">dt</span><span class="s3">[</span><span class="s1">dt</span><span class="s3">[</span><span class="s4">'Direction'</span><span class="s3">]</span><span class="s2">==</span><span class="s1">self</span><span class="s3">.</span><span class="s1">direction</span><span class="s3">]</span>
        <span class="s1">dd</span><span class="s2">=</span><span class="s1">dd</span><span class="s3">[</span><span class="s1">dd</span><span class="s3">[</span><span class="s4">'From'</span><span class="s3">]</span><span class="s2">==</span><span class="s1">location</span><span class="s3">]</span>

        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">dd</span><span class="s3">)</span><span class="s2">==</span><span class="s5">0</span><span class="s2">:</span>
            <span class="s0"># last node in a direction, the last passengers leave the train</span>
            <span class="s0"># and the train moves into the Cross-Over or the Depot</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">drive_time</span><span class="s2">=</span><span class="s5">20</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dwell_time</span><span class="s2">=</span><span class="s5">60</span>
        <span class="s2">else:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">drive_time</span><span class="s2">=</span><span class="s1">dd</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">at</span><span class="s3">[</span><span class="s4">'Drive Time'</span><span class="s3">]</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dwell_time</span><span class="s2">=</span><span class="s1">dd</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">at</span><span class="s3">[</span><span class="s4">'Dwell Time'</span><span class="s3">]</span>
            
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dist_drive_time </span><span class="s2">= </span><span class="s1">\</span>
        <span class="s1">stats</span><span class="s3">.</span><span class="s1">expon</span><span class="s3">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">drive_time</span><span class="s3">, </span>
                        <span class="s1">scale</span><span class="s2">=</span><span class="s1">scale_drive</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">drive_time</span><span class="s3">))</span>
        
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dwell_time </span><span class="s2">= </span><span class="s1">\</span>
            <span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dwell_time</span><span class="s3">, </span>
                       <span class="s1">scale</span><span class="s2">=</span><span class="s1">scale_dwell</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dwell_time</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">driveTime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_drive_time</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">()</span>
    
    <span class="s2">def </span><span class="s1">dwellTime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">x</span><span class="s2">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dist_dwell_time</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">x</span><span class="s2">&lt;</span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">x</span><span class="s2">=</span><span class="s5">1</span>
        <span class="s2">if </span><span class="s1">x</span><span class="s2">&lt;</span><span class="s5">5</span><span class="s2">:</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">*</span><span class="s5">3</span>
        <span class="s2">return </span><span class="s1">x</span>

    <span class="s2">def </span><span class="s1">__str__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">location </span><span class="s2">+ </span><span class="s4">&quot; (&quot; </span><span class="s2">+ </span><span class="s1">self</span><span class="s3">.</span><span class="s1">direction</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] </span><span class="s2">+ </span><span class="s4">&quot;)&quot;</span>
    
    <span class="s2">def </span><span class="s1">getResource</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">resource</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">#### Incidents 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">class </span><span class="s1">Incident</span><span class="s2">:</span>
    
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">stop</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">start </span><span class="s2">= </span><span class="s1">parseTime</span><span class="s3">(</span><span class="s1">start</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">stop </span><span class="s2">= </span><span class="s1">parseTime</span><span class="s3">(</span><span class="s1">stop</span><span class="s3">)</span>
        
    <span class="s2">def </span><span class="s1">active</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">start </span><span class="s2">&lt;= </span><span class="s1">env</span><span class="s3">.</span><span class="s1">now </span><span class="s2">and </span><span class="s1">env</span><span class="s3">.</span><span class="s1">now </span><span class="s2">&lt;= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stop</span>
    
    <span class="s2">def </span><span class="s1">startTime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">start</span>
    
    <span class="s2">def </span><span class="s1">stopTime</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">stop</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Train 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">class </span><span class="s1">Train</span><span class="s3">(</span><span class="s1">object</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">track</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">no</span><span class="s2">=</span><span class="s1">i</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">track </span><span class="s2">= </span><span class="s1">track</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">direction </span><span class="s2">= None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracing </span><span class="s2">= False</span>

    <span class="s2">def </span><span class="s1">setDirection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">direction</span><span class="s2">=</span><span class="s1">direction</span>

    <span class="s2">def </span><span class="s1">getDirection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">direction</span>
    
    <span class="s2">def </span><span class="s1">getNo</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">no</span>
    
    <span class="s2">def </span><span class="s1">isTracing</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">track</span><span class="s3">.</span><span class="s1">isTracing</span><span class="s3">() </span><span class="s2">and </span><span class="s1">\</span>
                <span class="s3">(</span><span class="s2">not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">track</span><span class="s3">.</span><span class="s1">isTracingTrains</span><span class="s3">() </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracing</span><span class="s3">)</span>
    
    <span class="s2">def </span><span class="s1">trace</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracing</span><span class="s2">=True</span>
            
    <span class="s2">def </span><span class="s1">traceOff</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracing</span><span class="s2">=False</span>

    <span class="s2">def </span><span class="s1">process</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>

        <span class="s1">blocks </span><span class="s2">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">track</span><span class="s3">.</span><span class="s1">getBlocks</span><span class="s3">()</span>

        <span class="s1">here</span><span class="s2">=</span><span class="s1">blocks</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">here_req </span><span class="s2">= None</span>

        <span class="s2">for </span><span class="s1">dest </span><span class="s2">in </span><span class="s1">blocks</span><span class="s3">[</span><span class="s5">1</span><span class="s2">:</span><span class="s3">]</span><span class="s2">:</span>

            <span class="s1">drivetime</span><span class="s2">=</span><span class="s1">here</span><span class="s3">.</span><span class="s1">driveTime</span><span class="s3">()</span>
            <span class="s1">dwelltime</span><span class="s2">=</span><span class="s1">here</span><span class="s3">.</span><span class="s1">dwellTime</span><span class="s3">()</span>

            <span class="s2">yield </span><span class="s1">env</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">(</span><span class="s1">dwelltime</span><span class="s3">)</span>
            
            <span class="s2">if </span><span class="s1">here</span><span class="s3">.</span><span class="s1">isIncident</span><span class="s3">()</span><span class="s2">:</span>
                <span class="s1">here</span><span class="s3">.</span><span class="s1">inc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
                <span class="s2">yield </span><span class="s1">env</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">(</span><span class="s1">here</span><span class="s3">.</span><span class="s1">incidentDelay</span><span class="s3">())</span>
                <span class="s1">here</span><span class="s3">.</span><span class="s1">inc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
            
            <span class="s2">if </span><span class="s1">dest</span><span class="s3">.</span><span class="s1">getResource</span><span class="s3">() </span><span class="s2">is not None:</span>
                <span class="s1">dest_req </span><span class="s2">= </span><span class="s1">dest</span><span class="s3">.</span><span class="s1">getResource</span><span class="s3">().</span><span class="s1">request</span><span class="s3">()</span>
                <span class="s2">yield </span><span class="s1">dest_req</span>
            <span class="s2">else:</span>
                <span class="s1">dest_req </span><span class="s2">= None</span>
                
            <span class="s0"># if the train doesn't get immediate access, it continues waiting </span>
            <span class="s0"># in the current station ('here').</span>
            <span class="s0"># if the train got access the train departs from 'here'for 'dest'</span>

            <span class="s1">here</span><span class="s3">.</span><span class="s1">dep</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dest</span><span class="s3">)</span>

            <span class="s0"># Once the train has completely left the station, the train</span>
            <span class="s0"># will release the track of station ('here'). </span>
            <span class="s0"># We assume that the train has left the station after 10 secs  </span>
            <span class="s1">delaytime</span><span class="s2">=</span><span class="s1">min</span><span class="s3">(</span><span class="s1">drivetime</span><span class="s3">, </span><span class="s1">signalFreeTime</span><span class="s3">)</span>
            <span class="s2">yield </span><span class="s1">env</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">(</span><span class="s1">delaytime</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">here_req </span><span class="s2">is not None:</span>
                <span class="s1">here</span><span class="s3">.</span><span class="s1">getResource</span><span class="s3">().</span><span class="s1">release</span><span class="s3">(</span><span class="s1">here_req</span><span class="s3">)</span>

            <span class="s0"># the train proceeds to drive to the next station ('dest')</span>
            <span class="s2">yield </span><span class="s1">env</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">(</span><span class="s1">drivetime</span><span class="s2">-</span><span class="s1">delaytime</span><span class="s3">)</span>

            <span class="s1">dest</span><span class="s3">.</span><span class="s1">arr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>
            <span class="s1">here </span><span class="s2">= </span><span class="s1">dest</span>
            <span class="s1">here_req</span><span class="s2">=</span><span class="s1">dest_req</span>


<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Tracks 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">A track describes a direction of a line. The parameters describing a track are: 
- The start and stop times of the line (for example 6:00 to 23:00), 
- The time between trains (for example every 5 minutes), but this may vary during the day. 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">class </span><span class="s1">Track</span><span class="s3">(</span><span class="s1">object</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">network</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">, </span><span class="s1">depot</span><span class="s3">, </span><span class="s1">blocks</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">network</span><span class="s2">=</span><span class="s1">network</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">direction</span><span class="s2">=</span><span class="s1">direction</span>
        
        <span class="s0"># extract line specific parameters</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">start </span><span class="s2">= </span><span class="s1">dt</span><span class="s3">.</span><span class="s1">at</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s4">'start'</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">stop  </span><span class="s2">= </span><span class="s1">dt</span><span class="s3">.</span><span class="s1">at</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s4">'stop'</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">freq  </span><span class="s2">= </span><span class="s1">dt</span><span class="s3">.</span><span class="s1">at</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s4">'freq'</span><span class="s3">]</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">track</span><span class="s2">=</span><span class="s3">[</span><span class="s1">depot</span><span class="s3">]</span><span class="s2">+</span><span class="s1">blocks</span>
        <span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">track</span><span class="s2">:</span>
            <span class="s1">s</span><span class="s3">.</span><span class="s1">setTrack</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracing</span><span class="s2">=False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracingTrains</span><span class="s2">=False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracingTrainNos</span><span class="s2">=</span><span class="s3">[]</span>


    <span class="s2">def </span><span class="s1">isTracing</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracing </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">network</span><span class="s3">.</span><span class="s1">isTracing</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">isTracingTrains</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracingTrains </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">network</span><span class="s3">.</span><span class="s1">isTracing</span><span class="s3">()</span>
                
    <span class="s2">def </span><span class="s1">trace</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">loc</span><span class="s2">=None</span><span class="s3">, </span><span class="s1">train</span><span class="s2">=None</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracing</span><span class="s2">=True</span>
        <span class="s2">if </span><span class="s1">loc </span><span class="s2">is None:</span>
            <span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">track</span><span class="s2">:</span>
                <span class="s1">s</span><span class="s3">.</span><span class="s1">trace</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">train </span><span class="s2">is not None:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">tracingTrains</span><span class="s2">=True</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">tracingTrainNos</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">train</span><span class="s3">)</span>
        <span class="s2">else:</span>
            <span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">track</span><span class="s2">:</span>
                <span class="s2">if </span><span class="s1">s</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">()</span><span class="s2">==</span><span class="s1">loc</span><span class="s2">:</span>
                    <span class="s1">s</span><span class="s3">.</span><span class="s1">trace</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">train </span><span class="s2">is not None:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">tracingTrains</span><span class="s2">=True</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">tracingTrainNos</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">train</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">getNetwork</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">network</span>

    <span class="s2">def </span><span class="s1">getLine</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line</span>
    
    <span class="s2">def </span><span class="s1">getName</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">direction </span><span class="s2">is None:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line</span>
        <span class="s2">else:</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">line </span><span class="s2">+ </span><span class="s4">&quot; (&quot;</span><span class="s2">+</span><span class="s1">self</span><span class="s3">.</span><span class="s1">direction</span><span class="s2">+</span><span class="s4">&quot;)&quot;</span>

    <span class="s2">def </span><span class="s1">getBlocks</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">track</span>

<span class="s0">#     def setTiming(self, start, stop, timing):</span>
<span class="s0">#         self.start=start*3600</span>
<span class="s0">#         self.stop=stop*3600</span>
<span class="s0">#         self.timing=timing</span>

    <span class="s2">def </span><span class="s1">process</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">yield </span><span class="s1">env</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">start</span><span class="s2">-</span><span class="s1">env</span><span class="s3">.</span><span class="s1">now</span><span class="s3">) </span><span class="s0"># the line starts operating at 6am</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">int</span><span class="s3">((</span><span class="s1">self</span><span class="s3">.</span><span class="s1">stop</span><span class="s2">-</span><span class="s1">self</span><span class="s3">.</span><span class="s1">start</span><span class="s3">)</span><span class="s2">/</span><span class="s1">self</span><span class="s3">.</span><span class="s1">freq</span><span class="s3">))</span><span class="s2">:</span>
            <span class="s1">t</span><span class="s2">=</span><span class="s1">Train</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">self</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracingTrains </span><span class="s2">and </span><span class="s1">i </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracingTrainNos</span><span class="s2">:</span>
                <span class="s1">t</span><span class="s3">.</span><span class="s1">trace</span><span class="s3">()</span>
            <span class="s1">env</span><span class="s3">.</span><span class="s1">process</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">process</span><span class="s3">())</span>
            <span class="s2">yield </span><span class="s1">env</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">freq</span><span class="s3">)</span>
            
    <span class="s2">def </span><span class="s1">getArrData</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">n</span><span class="s2">=</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">track</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s1">getArrivalTimes</span><span class="s3">())</span><span class="s2">-</span><span class="s5">1</span>
        <span class="s1">sd</span><span class="s2">=</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">index</span><span class="s2">=</span><span class="s1">range</span><span class="s3">(</span><span class="s1">n</span><span class="s3">))</span>
        <span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">track</span><span class="s2">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s1">Station</span><span class="s3">)</span><span class="s2">:</span>
                <span class="s1">col </span><span class="s2">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">()</span><span class="s2">+</span><span class="s4">&quot; (&quot;</span><span class="s2">+</span><span class="s1">s</span><span class="s3">.</span><span class="s1">direction</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span><span class="s2">+</span><span class="s4">&quot;)&quot;</span>
                <span class="s1">sd</span><span class="s3">[</span><span class="s1">col</span><span class="s2">+</span><span class="s4">&quot; IARR&quot; </span><span class="s3">]</span><span class="s2">= </span><span class="s3">[ </span><span class="s1">s</span><span class="s3">.</span><span class="s1">arr_time</span><span class="s3">[</span><span class="s1">i</span><span class="s2">+</span><span class="s5">1</span><span class="s3">]</span><span class="s2">-</span><span class="s1">s</span><span class="s3">.</span><span class="s1">arr_time</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)]</span>
                <span class="s1">sd</span><span class="s3">[</span><span class="s1">col</span><span class="s2">+</span><span class="s4">&quot; ARR&quot; </span><span class="s3">]</span><span class="s2">= </span><span class="s3">[</span><span class="s1">s</span><span class="s3">.</span><span class="s1">arr_time</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)]</span>
        <span class="s2">return </span><span class="s1">sd</span>
    
    <span class="s2">def </span><span class="s1">getDepData</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">n</span><span class="s2">=</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">track</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s1">getDepartureTimes</span><span class="s3">())</span><span class="s2">-</span><span class="s5">1</span>
        <span class="s1">sd</span><span class="s2">=</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">index</span><span class="s2">=</span><span class="s1">range</span><span class="s3">(</span><span class="s1">n</span><span class="s3">))</span>
        <span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">track</span><span class="s2">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s1">Station</span><span class="s3">)</span><span class="s2">:</span>
                <span class="s1">dep_col</span><span class="s2">=</span><span class="s1">s</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">()</span><span class="s2">+</span><span class="s4">&quot; (&quot;</span><span class="s2">+</span><span class="s1">s</span><span class="s3">.</span><span class="s1">direction</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span><span class="s2">+</span><span class="s4">&quot;)&quot;</span>
                <span class="s1">sd</span><span class="s3">[</span><span class="s1">dep_col</span><span class="s2">+</span><span class="s4">&quot; IDEP&quot;</span><span class="s3">]</span><span class="s2">=</span><span class="s3">[</span><span class="s1">s</span><span class="s3">.</span><span class="s1">dep_time</span><span class="s3">[</span><span class="s1">i</span><span class="s2">+</span><span class="s5">1</span><span class="s3">]</span><span class="s2">-</span><span class="s1">s</span><span class="s3">.</span><span class="s1">dep_time</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)]</span>
                <span class="s1">sd</span><span class="s3">[</span><span class="s1">dep_col</span><span class="s2">+</span><span class="s4">&quot; DEP&quot; </span><span class="s3">]</span><span class="s2">= </span><span class="s3">[</span><span class="s1">s</span><span class="s3">.</span><span class="s1">dep_time</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)]</span>
        <span class="s2">return </span><span class="s1">sd</span>

    <span class="s2">def </span><span class="s1">__str__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">direction </span><span class="s2">= </span><span class="s4">&quot;&quot; </span><span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">direction </span><span class="s2">is None else </span><span class="s4">&quot; (&quot;</span><span class="s2">+</span><span class="s1">self</span><span class="s3">.</span><span class="s1">direction</span><span class="s2">+</span><span class="s4">&quot;)&quot;</span>
        <span class="s1">stations </span><span class="s2">= </span><span class="s4">&quot; - &quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">([ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">s</span><span class="s3">) </span><span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">track </span><span class="s3">])</span>
        <span class="s2">return </span><span class="s1">direction </span><span class="s2">+ </span><span class="s4">&quot;: &quot; </span><span class="s2">+ </span><span class="s1">stations</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### The Network 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">allBlocks</span><span class="s3">(</span><span class="s1">direction</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s1">ds</span><span class="s2">=</span><span class="s1">dt</span><span class="s3">[</span><span class="s1">dt</span><span class="s3">[</span><span class="s4">'Direction'</span><span class="s3">]</span><span class="s2">==</span><span class="s1">direction</span><span class="s3">]</span>
    <span class="s1">blocks</span><span class="s2">=</span><span class="s1">dt</span><span class="s3">[</span><span class="s4">'From'</span><span class="s3">].</span><span class="s1">to_list</span><span class="s3">()</span>
    <span class="s1">blocks</span><span class="s2">+=</span><span class="s3">[</span><span class="s1">dt</span><span class="s3">[</span><span class="s4">'To'</span><span class="s3">].</span><span class="s1">to_list</span><span class="s3">()[</span><span class="s2">-</span><span class="s5">1</span><span class="s3">]]</span>
    <span class="s2">return </span><span class="s3">[ </span><span class="s1">Block</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s1">direction</span><span class="s3">) </span><span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">blocks </span><span class="s3">]</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">allTracks</span><span class="s3">(</span><span class="s1">network</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s1">lines</span><span class="s2">=</span><span class="s3">[]</span>
    
    <span class="s1">directions</span><span class="s2">=</span><span class="s1">dt</span><span class="s3">[</span><span class="s4">'Direction'</span><span class="s3">].</span><span class="s1">unique</span><span class="s3">()</span>
    <span class="s1">blocks</span><span class="s2">=</span><span class="s3">[ </span><span class="s1">allBlocks</span><span class="s3">(</span><span class="s1">d</span><span class="s3">) </span><span class="s2">for </span><span class="s1">d </span><span class="s2">in </span><span class="s1">directions</span><span class="s3">]</span>
    
    <span class="s1">depot </span><span class="s2">= </span><span class="s1">Depot</span><span class="s3">(</span><span class="s4">&quot;LOND&quot;</span><span class="s3">, </span><span class="s1">directions</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">station </span><span class="s2">= </span><span class="s1">Station</span><span class="s3">(</span><span class="s4">&quot;LOND&quot;</span><span class="s3">, </span><span class="s1">directions</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">depotL </span><span class="s2">= </span><span class="s1">Depot</span><span class="s3">(</span><span class="s4">&quot;BIRM&quot;</span><span class="s3">, </span><span class="s1">directions</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">stationL </span><span class="s2">= </span><span class="s1">Station</span><span class="s3">(</span><span class="s4">&quot;BIRM&quot;</span><span class="s3">, </span><span class="s1">directions</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">l </span><span class="s2">= </span><span class="s1">Track</span><span class="s3">(</span><span class="s1">network</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">depot</span><span class="s3">, [</span><span class="s1">station</span><span class="s3">] </span><span class="s2">+ </span><span class="s1">blocks</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] </span><span class="s2">+ </span><span class="s3">[</span><span class="s1">stationL</span><span class="s3">] </span><span class="s2">+ </span><span class="s3">[</span><span class="s1">depotL</span><span class="s3">])</span>
    <span class="s1">lines </span><span class="s2">+= </span><span class="s3">[</span><span class="s1">l</span><span class="s3">]</span>

    <span class="s2">return </span><span class="s1">lines</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s2">class </span><span class="s1">Network</span><span class="s3">(</span><span class="s1">object</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracks</span><span class="s2">=</span><span class="s1">allTracks</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracing</span><span class="s2">=False</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracingStart</span><span class="s2">=None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracingStop</span><span class="s2">=None</span>
        
    <span class="s2">def </span><span class="s1">getTracks</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracks</span>

    <span class="s2">def </span><span class="s1">isTracing</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracing </span><span class="s2">and </span><span class="s1">\</span>
                <span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracingStart </span><span class="s2">is None or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracingStart</span><span class="s2">&lt;=</span><span class="s1">env</span><span class="s3">.</span><span class="s1">now</span><span class="s3">) </span><span class="s2">and </span><span class="s1">\</span>
                <span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracingStop </span><span class="s2">is None or </span><span class="s1">env</span><span class="s3">.</span><span class="s1">now </span><span class="s2">&lt;= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracingStop</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">trace</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">loc</span><span class="s2">=None</span><span class="s3">, </span><span class="s1">train</span><span class="s2">=None</span><span class="s3">, </span><span class="s1">start</span><span class="s2">=None</span><span class="s3">, </span><span class="s1">stop</span><span class="s2">=None</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracing </span><span class="s2">= True</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracingStart </span><span class="s2">= </span><span class="s1">parseTime</span><span class="s3">(</span><span class="s1">start</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tracingStop </span><span class="s2">= </span><span class="s1">parseTime</span><span class="s3">(</span><span class="s1">stop</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracks</span><span class="s2">:</span>
            <span class="s1">t</span><span class="s3">.</span><span class="s1">trace</span><span class="s3">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">train</span><span class="s2">=</span><span class="s1">train</span><span class="s3">)</span>
            
    <span class="s2">def </span><span class="s1">registerIncident</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">start</span><span class="s3">, </span><span class="s1">stop</span><span class="s3">, </span><span class="s1">direction</span><span class="s2">=None</span><span class="s3">, </span><span class="s1">loc</span><span class="s2">=None</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">incident </span><span class="s2">= </span><span class="s1">Incident</span><span class="s3">(</span><span class="s1">start</span><span class="s3">, </span><span class="s1">stop</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracks</span><span class="s2">:</span>
            <span class="s2">for </span><span class="s1">s </span><span class="s2">in </span><span class="s1">t</span><span class="s3">.</span><span class="s1">getBlocks</span><span class="s3">()</span><span class="s2">:</span>
                <span class="s2">if </span><span class="s1">direction </span><span class="s2">is None or </span><span class="s1">s</span><span class="s3">.</span><span class="s1">getDirection</span><span class="s3">()</span><span class="s2">==</span><span class="s1">direction</span><span class="s2">:</span>
                    <span class="s2">if </span><span class="s1">loc </span><span class="s2">is None or </span><span class="s1">s</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">()</span><span class="s2">==</span><span class="s1">loc</span><span class="s2">:</span>
                        <span class="s1">s</span><span class="s3">.</span><span class="s1">registerIncident</span><span class="s3">(</span><span class="s1">incident</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">process</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tracks</span><span class="s2">:</span>
            <span class="s0">#t.setTiming(self.start, self.stop, self.timing)</span>
            <span class="s0">#yield env.timeout(self.start-env.now) # the line starts operating at 6am</span>
            <span class="s2">yield </span><span class="s1">env</span><span class="s3">.</span><span class="s1">timeout</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
            <span class="s1">env</span><span class="s3">.</span><span class="s1">process</span><span class="s3">(</span><span class="s1">t</span><span class="s3">.</span><span class="s1">process</span><span class="s3">())</span>

<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1"># Utilities 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">## Global Parameters 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">max_direction_length </span><span class="s2">= </span><span class="s1">max</span><span class="s3">([</span><span class="s1">len</span><span class="s3">(</span><span class="s1">dir</span><span class="s3">) </span><span class="s2">for </span><span class="s1">dir </span><span class="s2">in </span><span class="s1">dt</span><span class="s3">[</span><span class="s4">'Direction'</span><span class="s3">].</span><span class="s1">unique</span><span class="s3">()])</span>
<span class="s1">station_dwell_time </span><span class="s2">= </span><span class="s5">15</span>
<span class="s1">station_drive_time </span><span class="s2">= </span><span class="s5">20</span>
<span class="s1">depot_dwell_time </span><span class="s2">= </span><span class="s5">10</span>
<span class="s1">depot_drive_time </span><span class="s2">= </span><span class="s5">20</span>
<span class="s1">signalFreeTime </span><span class="s2">= </span><span class="s5">5</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">isPeakTime</span><span class="s3">()</span><span class="s2">:</span>
    <span class="s1">now</span><span class="s2">=</span><span class="s1">env</span><span class="s3">.</span><span class="s1">now</span>
    <span class="s2">return </span><span class="s3">(</span><span class="s5">3600</span><span class="s2">*</span><span class="s5">7</span><span class="s2">&lt;=</span><span class="s1">now </span><span class="s2">and </span><span class="s1">now</span><span class="s2">&lt;=</span><span class="s5">3600</span><span class="s2">*</span><span class="s5">10</span><span class="s3">) </span><span class="s2">or </span><span class="s1">\</span>
           <span class="s3">(</span><span class="s5">3600</span><span class="s2">*</span><span class="s5">16</span><span class="s2">&lt;=</span><span class="s1">now </span><span class="s2">and </span><span class="s1">now</span><span class="s2">&lt;=</span><span class="s5">3600</span><span class="s2">*</span><span class="s5">19</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">## Time Parsing and Formating 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">Format time in seconds as hh:mm:ss 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">daytime</span><span class="s3">(</span><span class="s1">t</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s1">t</span><span class="s2">=</span><span class="s1">int</span><span class="s3">(</span><span class="s1">t</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s4">f&quot;</span><span class="s6">{</span><span class="s1">t</span><span class="s2">//</span><span class="s5">3600</span><span class="s6">:</span><span class="s4">02d</span><span class="s6">}</span><span class="s4">:</span><span class="s6">{</span><span class="s3">(</span><span class="s1">t</span><span class="s2">%</span><span class="s5">3600</span><span class="s3">)</span><span class="s2">//</span><span class="s5">60</span><span class="s6">:</span><span class="s4">02d</span><span class="s6">}</span><span class="s4">:</span><span class="s6">{</span><span class="s1">t</span><span class="s2">%</span><span class="s5">60</span><span class="s6">:</span><span class="s4">02d</span><span class="s6">}</span><span class="s4">&quot;</span>
<span class="s2">def </span><span class="s1">now</span><span class="s3">()</span><span class="s2">:</span>
    <span class="s2">return </span><span class="s1">daytime</span><span class="s3">(</span><span class="s1">env</span><span class="s3">.</span><span class="s1">now</span><span class="s3">)</span>

<span class="s2">def </span><span class="s1">parseTime</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s2">if </span><span class="s1">s </span><span class="s2">is None:</span>
        <span class="s2">return None</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s1">str</span><span class="s3">)</span><span class="s2">:</span>
        <span class="s1">parts</span><span class="s2">=</span><span class="s1">s</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">':'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">)</span><span class="s2">&gt;=</span><span class="s5">2</span><span class="s2">:</span>
            <span class="s1">hours</span><span class="s2">=</span><span class="s1">int</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
            <span class="s1">minutes</span><span class="s2">=</span><span class="s1">int</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>
            <span class="s1">seconds</span><span class="s2">=</span><span class="s5">0 </span><span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">)</span><span class="s2">==</span><span class="s5">2 </span><span class="s2">else </span><span class="s1">int</span><span class="s3">(</span><span class="s1">parts</span><span class="s3">[</span><span class="s5">2</span><span class="s3">])</span>
            <span class="s2">return </span><span class="s5">3600</span><span class="s2">*</span><span class="s1">hours</span><span class="s2">+</span><span class="s5">60</span><span class="s2">*</span><span class="s1">minutes</span><span class="s2">+</span><span class="s1">seconds</span>
    <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;WARNING Parsing Error:&quot;</span><span class="s3">, </span><span class="s1">s</span><span class="s3">)</span>
    <span class="s0"># any wrong formats will be passed through and may cause </span>
    <span class="s0"># an error at a later stage</span>
    <span class="s2">return </span><span class="s1">s</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">## Setting System Parameters 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">dt</span><span class="s3">[</span><span class="s4">'start'</span><span class="s3">] </span><span class="s2">= </span><span class="s1">parseTime</span><span class="s3">(</span><span class="s4">&quot;07:00:00&quot;</span><span class="s3">)</span>
<span class="s1">dt</span><span class="s3">[</span><span class="s4">'stop'</span><span class="s3">]  </span><span class="s2">= </span><span class="s1">parseTime</span><span class="s3">(</span><span class="s4">&quot;22:00:00&quot;</span><span class="s3">)</span>
<span class="s1">dt</span><span class="s3">[</span><span class="s4">'freq'</span><span class="s3">]  </span><span class="s2">= </span><span class="s1">parseTime</span><span class="s3">(</span><span class="s4">&quot;00:08:50&quot;</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">## System Verification 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s3">(</span><span class="s1">dt</span><span class="s3">[</span><span class="s4">'Running Time'</span><span class="s3">].</span><span class="s1">sum</span><span class="s3">() </span><span class="s2">+ </span><span class="s3">(</span><span class="s5">5</span><span class="s2">*</span><span class="s5">8</span><span class="s3">) </span><span class="s2">+ </span><span class="s3">(</span><span class="s5">60</span><span class="s2">*</span><span class="s5">2</span><span class="s3">) </span><span class="s2">+ </span><span class="s3">(</span><span class="s5">20</span><span class="s2">*</span><span class="s5">2</span><span class="s3">))</span><span class="s2">/</span><span class="s5">6</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Normal operations 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>

<span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
<span class="s1">env </span><span class="s2">= </span><span class="s1">simpy</span><span class="s3">.</span><span class="s1">Environment</span><span class="s3">()</span>
<span class="s1">network</span><span class="s2">=</span><span class="s1">Network</span><span class="s3">()</span>
<span class="s1">network</span><span class="s3">.</span><span class="s1">trace</span><span class="s3">()</span>

<span class="s1">env</span><span class="s3">.</span><span class="s1">process</span><span class="s3">(</span><span class="s1">network</span><span class="s3">.</span><span class="s1">process</span><span class="s3">())</span>
<span class="s1">env</span><span class="s3">.</span><span class="s1">run</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Incidents 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">Verify complete trace over a period of time around the incident. In particular check that the trains followings after come to a stop and resume operations after the incident was cleared. 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">env </span><span class="s2">= </span><span class="s1">simpy</span><span class="s3">.</span><span class="s1">Environment</span><span class="s3">()</span>
<span class="s1">network</span><span class="s2">=</span><span class="s1">Network</span><span class="s3">()</span>

<span class="s1">network</span><span class="s3">.</span><span class="s1">trace</span><span class="s3">()</span>
<span class="s1">network</span><span class="s3">.</span><span class="s1">registerIncident</span><span class="s3">(</span><span class="s1">start</span><span class="s2">=</span><span class="s4">&quot;09:00&quot;</span><span class="s3">, </span><span class="s1">stop</span><span class="s2">=</span><span class="s4">&quot;09:30&quot;</span><span class="s3">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s4">&quot;P2&quot;</span><span class="s3">)</span>

<span class="s1">env</span><span class="s3">.</span><span class="s1">process</span><span class="s3">(</span><span class="s1">network</span><span class="s3">.</span><span class="s1">process</span><span class="s3">())</span>
<span class="s1">env</span><span class="s3">.</span><span class="s1">run</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">## Collect Statistics 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>

<span class="s1">env </span><span class="s2">= </span><span class="s1">simpy</span><span class="s3">.</span><span class="s1">Environment</span><span class="s3">()</span>
<span class="s1">network </span><span class="s2">= </span><span class="s1">Network</span><span class="s3">()</span>
<span class="s1">env</span><span class="s3">.</span><span class="s1">process</span><span class="s3">(</span><span class="s1">network</span><span class="s3">.</span><span class="s1">process</span><span class="s3">())</span>
<span class="s1">env</span><span class="s3">.</span><span class="s1">run</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">ARR </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">t</span><span class="s3">.</span><span class="s1">getArrData</span><span class="s3">() </span><span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">network</span><span class="s3">.</span><span class="s1">getTracks</span><span class="s3">() ]</span>
<span class="s1">DEP </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">t</span><span class="s3">.</span><span class="s1">getDepData</span><span class="s3">() </span><span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">network</span><span class="s3">.</span><span class="s1">getTracks</span><span class="s3">() ]</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### ARR 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">ARR</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">ARR</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">columns</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### DEP 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">DEP</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">DEP</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">columns</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### London Old Oak Commons 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">ARR</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">columns</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">#### Inter Arrival Time Distribution 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">arr </span><span class="s2">= </span><span class="s1">ARR</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s4">'LOND (Station) (L) IARR'</span><span class="s3">]</span>
<span class="s1">arr</span><span class="s3">.</span><span class="s1">describe</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">plotWithPdf</span><span class="s3">(</span><span class="s1">arr</span><span class="s3">, </span><span class="s1">xmin</span><span class="s2">=</span><span class="s5">350</span><span class="s3">, </span><span class="s1">xmax</span><span class="s2">=</span><span class="s5">750</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">350</span><span class="s3">, </span><span class="s5">750</span><span class="s3">, </span><span class="s5">41</span><span class="s3">))</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">#### Dwell Time Distribution 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">network</span><span class="s3">.</span><span class="s1">getTracks</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">getBlocks</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">network</span><span class="s3">.</span><span class="s1">getTracks</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">getBlocks</span><span class="s3">()[</span><span class="s5">1</span><span class="s3">]</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">dwell_time_dist</span><span class="s2">=</span><span class="s1">network</span><span class="s3">.</span><span class="s1">getTracks</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">getBlocks</span><span class="s3">()[</span><span class="s5">1</span><span class="s3">].</span><span class="s1">dist_dwell_time</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">dwell_times </span><span class="s2">= </span><span class="s1">dwell_time_dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">100</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">plot</span><span class="s3">(</span><span class="s1">dwell_times</span><span class="s3">, </span><span class="s1">pdf</span><span class="s2">=</span><span class="s1">dwell_time_dist</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">xmin</span><span class="s2">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">xmax</span><span class="s2">=</span><span class="s5">50</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">50</span><span class="s3">, </span><span class="s5">41</span><span class="s3">))</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">#### Inter Departure Time Distribution 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">dep </span><span class="s2">= </span><span class="s1">DEP</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s4">'LOND (Station) (L) IDEP'</span><span class="s3">]</span>
<span class="s1">dep</span><span class="s3">.</span><span class="s1">describe</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">plotWithPdf</span><span class="s3">(</span><span class="s1">dep</span><span class="s3">, </span><span class="s1">xmin</span><span class="s2">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">xmax</span><span class="s2">=</span><span class="s5">1000</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1000</span><span class="s3">, </span><span class="s5">41</span><span class="s3">))</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">#### Drive Time Distribution 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">drive_time_dist</span><span class="s2">=</span><span class="s1">network</span><span class="s3">.</span><span class="s1">getTracks</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">getBlocks</span><span class="s3">()[</span><span class="s5">1</span><span class="s3">].</span><span class="s1">dist_drive_time</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">drive_times </span><span class="s2">= </span><span class="s1">drive_time_dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">100</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">plot</span><span class="s3">(</span><span class="s1">drive_times</span><span class="s3">, </span><span class="s1">pdf</span><span class="s2">=</span><span class="s1">drive_time_dist</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">xmin</span><span class="s2">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">xmax</span><span class="s2">=</span><span class="s5">150</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">150</span><span class="s3">, </span><span class="s5">41</span><span class="s3">))</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Birmingham Interchange 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">ARR</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">columns</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">#### Inter Arrival Time Distribution 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">arr </span><span class="s2">= </span><span class="s1">ARR</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s4">'BIRM (Station) (L) IARR'</span><span class="s3">]</span>
<span class="s1">arr</span><span class="s3">.</span><span class="s1">describe</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">plotWithPdf</span><span class="s3">(</span><span class="s1">arr</span><span class="s3">, </span><span class="s1">xmin</span><span class="s2">=</span><span class="s5">350</span><span class="s3">, </span><span class="s1">xmax</span><span class="s2">=</span><span class="s5">750</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">350</span><span class="s3">, </span><span class="s5">750</span><span class="s3">, </span><span class="s5">41</span><span class="s3">))</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">#### Dwell Time Distribution 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">network</span><span class="s3">.</span><span class="s1">getTracks</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">getBlocks</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">network</span><span class="s3">.</span><span class="s1">getTracks</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">getBlocks</span><span class="s3">()[</span><span class="s2">-</span><span class="s5">2</span><span class="s3">]</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">dwell_time_dist</span><span class="s2">=</span><span class="s1">network</span><span class="s3">.</span><span class="s1">getTracks</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">getBlocks</span><span class="s3">()[</span><span class="s2">-</span><span class="s5">2</span><span class="s3">].</span><span class="s1">dist_dwell_time</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">dwell_times </span><span class="s2">= </span><span class="s1">dwell_time_dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">100</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">plot</span><span class="s3">(</span><span class="s1">dwell_times</span><span class="s3">, </span><span class="s1">pdf</span><span class="s2">=</span><span class="s1">dwell_time_dist</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">xmin</span><span class="s2">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">xmax</span><span class="s2">=</span><span class="s5">50</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">50</span><span class="s3">, </span><span class="s5">41</span><span class="s3">))</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">#### Inter Departure Time Distribution 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">dep </span><span class="s2">= </span><span class="s1">DEP</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s4">'BIRM (Station) (L) IDEP'</span><span class="s3">]</span>
<span class="s1">dep</span><span class="s3">.</span><span class="s1">describe</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">plotWithPdf</span><span class="s3">(</span><span class="s1">dep</span><span class="s3">, </span><span class="s1">xmin</span><span class="s2">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">xmax</span><span class="s2">=</span><span class="s5">1000</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1000</span><span class="s3">, </span><span class="s5">41</span><span class="s3">))</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">#### Drive Time Distribution 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">drive_time_dist</span><span class="s2">=</span><span class="s1">network</span><span class="s3">.</span><span class="s1">getTracks</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">getBlocks</span><span class="s3">()[</span><span class="s2">-</span><span class="s5">2</span><span class="s3">].</span><span class="s1">dist_drive_time</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">drive_times </span><span class="s2">= </span><span class="s1">drive_time_dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">100</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">plot</span><span class="s3">(</span><span class="s1">drive_times</span><span class="s3">, </span><span class="s1">pdf</span><span class="s2">=</span><span class="s1">drive_time_dist</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">xmin</span><span class="s2">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">xmax</span><span class="s2">=</span><span class="s5">150</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">150</span><span class="s3">, </span><span class="s5">41</span><span class="s3">))</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">## Delay Time 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">### Concatinating Arrival and Departure dataframe 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">trainSummary </span><span class="s2">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">()</span>
<span class="s1">trainSummary </span><span class="s2">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">concat</span><span class="s3">([</span><span class="s1">ARR</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">DEP</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]], </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s3">)</span>
<span class="s1">trainSummary</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Creating new dataframe with only Simulated (Departure &amp; Arrival) and others 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">trainSchd </span><span class="s2">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">()</span>
<span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;LOND-Dep&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">trainSummary</span><span class="s3">[</span><span class="s4">&quot;LOND (Station) (L) DEP&quot;</span><span class="s3">]</span>
<span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;BIRM-Arr&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">trainSummary</span><span class="s3">[</span><span class="s4">&quot;BIRM (Station) (L) ARR&quot;</span><span class="s3">]</span>
<span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Simulated Running Time&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;BIRM-Arr&quot;</span><span class="s3">] </span><span class="s2">- </span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;LOND-Dep&quot;</span><span class="s3">]</span>
<span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Scheduled Running Time&quot;</span><span class="s3">] </span><span class="s2">=</span><span class="s1">dt</span><span class="s3">[</span><span class="s4">&quot;Running Time&quot;</span><span class="s3">].</span><span class="s1">sum</span><span class="s3">()</span>
<span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Simulated Running Time&quot;</span><span class="s3">] </span><span class="s2">- </span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Scheduled Running Time&quot;</span><span class="s3">]</span>
<span class="s1">trainSchd</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Plotting delay time 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">].</span><span class="s1">describe</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">plotWithPdf</span><span class="s3">(</span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">], </span><span class="s1">xmin</span><span class="s2">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">xmax</span><span class="s2">=</span><span class="s5">1500</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1500</span><span class="s3">, </span><span class="s5">41</span><span class="s3">))</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">## Combine the code into a single routine 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">### Defining constants 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">mean</span><span class="s2">=</span><span class="s5">3.378</span>
<span class="s1">sigma</span><span class="s2">=</span><span class="s5">0.751</span>
<span class="s1">acc</span><span class="s2">=</span><span class="s5">0.76</span>
<span class="s1">dec</span><span class="s2">=</span><span class="s5">0.38</span>
<span class="s1">vel</span><span class="s2">=</span><span class="s5">86.1</span>
<span class="s1">dist</span><span class="s2">=</span><span class="s5">145000</span>
<span class="s1">start</span><span class="s2">=</span><span class="s4">&quot;07:00:00&quot;</span>
<span class="s1">stop</span><span class="s2">=</span><span class="s4">&quot;22:00:00&quot;</span>

<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Defining function 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">runLondBrim</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">log</span><span class="s2">=False</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s2">global </span><span class="s1">dt </span>
    <span class="s1">dt </span><span class="s2">= </span><span class="s1">blockData</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">, </span><span class="s1">acc</span><span class="s3">, </span><span class="s1">dec</span><span class="s3">, </span><span class="s1">vel</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">)</span>

    <span class="s1">dt</span><span class="s3">[</span><span class="s4">'start'</span><span class="s3">] </span><span class="s2">= </span><span class="s1">parseTime</span><span class="s3">(</span><span class="s1">start</span><span class="s3">)</span>
    <span class="s1">dt</span><span class="s3">[</span><span class="s4">'stop'</span><span class="s3">]  </span><span class="s2">= </span><span class="s1">parseTime</span><span class="s3">(</span><span class="s1">stop</span><span class="s3">)</span>
    <span class="s1">dt</span><span class="s3">[</span><span class="s4">'freq'</span><span class="s3">]  </span><span class="s2">= </span><span class="s1">dt</span><span class="s3">[</span><span class="s4">&quot;Running Time&quot;</span><span class="s3">].</span><span class="s1">mean</span><span class="s3">() </span><span class="s2">+ </span><span class="s1">depot_drive_time </span><span class="s2">+ </span><span class="s1">depot_dwell_time </span><span class="s2">+ </span><span class="s1">signalFreeTime</span>
    <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>

    <span class="s1">network </span><span class="s2">= </span><span class="s1">Network</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">log</span><span class="s2">:</span>
        <span class="s1">network</span><span class="s3">.</span><span class="s1">trace</span><span class="s3">()</span>
    <span class="s1">env</span><span class="s3">.</span><span class="s1">process</span><span class="s3">(</span><span class="s1">network</span><span class="s3">.</span><span class="s1">process</span><span class="s3">())</span>
    <span class="s1">env</span><span class="s3">.</span><span class="s1">run</span><span class="s3">()</span>

    <span class="s1">ARR </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">t</span><span class="s3">.</span><span class="s1">getArrData</span><span class="s3">() </span><span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">network</span><span class="s3">.</span><span class="s1">getTracks</span><span class="s3">() ]</span>
    <span class="s1">DEP </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">t</span><span class="s3">.</span><span class="s1">getDepData</span><span class="s3">() </span><span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">network</span><span class="s3">.</span><span class="s1">getTracks</span><span class="s3">() ]</span>
    
    <span class="s1">trainSummary </span><span class="s2">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">()</span>
    <span class="s1">trainSummary </span><span class="s2">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">concat</span><span class="s3">([</span><span class="s1">ARR</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">DEP</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]], </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">trainSchd </span><span class="s2">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">()</span>
    <span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;LOND-Dep&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">trainSummary</span><span class="s3">[</span><span class="s4">&quot;LOND (Station) (L) DEP&quot;</span><span class="s3">]</span>
    <span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;BIRM-Arr&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">trainSummary</span><span class="s3">[</span><span class="s4">&quot;BIRM (Station) (L) ARR&quot;</span><span class="s3">]</span>
    <span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Simulated Running Time&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;BIRM-Arr&quot;</span><span class="s3">] </span><span class="s2">- </span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;LOND-Dep&quot;</span><span class="s3">]</span>
    <span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Scheduled Running Time&quot;</span><span class="s3">] </span><span class="s2">=</span><span class="s1">dt</span><span class="s3">[</span><span class="s4">&quot;Running Time&quot;</span><span class="s3">].</span><span class="s1">sum</span><span class="s3">()</span>
    <span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Simulated Running Time&quot;</span><span class="s3">] </span><span class="s2">- </span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Scheduled Running Time&quot;</span><span class="s3">]</span>
    
    <span class="s1">trainPerHour </span><span class="s2">= </span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">].</span><span class="s1">count</span><span class="s3">()</span><span class="s2">//</span><span class="s1">int</span><span class="s3">((</span><span class="s1">parseTime</span><span class="s3">(</span><span class="s1">stop</span><span class="s3">) </span><span class="s2">- </span><span class="s1">parseTime</span><span class="s3">(</span><span class="s1">start</span><span class="s3">))</span><span class="s2">/</span><span class="s5">3600</span><span class="s3">)</span>
    
    
    <span class="s2">return </span><span class="s1">trainPerHour</span><span class="s3">, </span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">].</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">trainSummary</span><span class="s3">[</span><span class="s4">&quot;BIRM (Station) (L) IARR&quot;</span><span class="s3">].</span><span class="s1">mean</span><span class="s3">()</span>


<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">## Optimisation 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">### Optimal Schedule 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">schedule</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">log</span><span class="s2">=False</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s2">global </span><span class="s1">dt</span>
    <span class="s1">dt </span><span class="s2">= </span><span class="s1">blockData</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">, </span><span class="s1">acc</span><span class="s3">, </span><span class="s1">dec</span><span class="s3">, </span><span class="s1">vel</span><span class="s3">, </span><span class="s1">dist</span><span class="s3">)</span>

    <span class="s1">dt</span><span class="s3">[</span><span class="s4">'start'</span><span class="s3">] </span><span class="s2">= </span><span class="s1">parseTime</span><span class="s3">(</span><span class="s1">start</span><span class="s3">)</span>
    <span class="s1">dt</span><span class="s3">[</span><span class="s4">'stop'</span><span class="s3">]  </span><span class="s2">= </span><span class="s1">parseTime</span><span class="s3">(</span><span class="s1">stop</span><span class="s3">)</span>
    <span class="s1">dt</span><span class="s3">[</span><span class="s4">'freq'</span><span class="s3">]  </span><span class="s2">= </span><span class="s1">dt</span><span class="s3">[</span><span class="s4">&quot;Running Time&quot;</span><span class="s3">].</span><span class="s1">mean</span><span class="s3">() </span><span class="s2">+ </span><span class="s1">depot_drive_time </span><span class="s2">+ </span><span class="s1">depot_dwell_time </span><span class="s2">+ </span><span class="s1">signalFreeTime</span>
    <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>

    <span class="s1">network </span><span class="s2">= </span><span class="s1">Network</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">log</span><span class="s2">:</span>
        <span class="s1">network</span><span class="s3">.</span><span class="s1">trace</span><span class="s3">()</span>
    <span class="s1">env</span><span class="s3">.</span><span class="s1">process</span><span class="s3">(</span><span class="s1">network</span><span class="s3">.</span><span class="s1">process</span><span class="s3">())</span>
    <span class="s1">env</span><span class="s3">.</span><span class="s1">run</span><span class="s3">()</span>

    <span class="s1">ARR </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">t</span><span class="s3">.</span><span class="s1">getArrData</span><span class="s3">() </span><span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">network</span><span class="s3">.</span><span class="s1">getTracks</span><span class="s3">() ]</span>
    <span class="s1">DEP </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">t</span><span class="s3">.</span><span class="s1">getDepData</span><span class="s3">() </span><span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">network</span><span class="s3">.</span><span class="s1">getTracks</span><span class="s3">() ]</span>

    <span class="s1">trainSummary </span><span class="s2">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">()</span>
    <span class="s1">trainSummary </span><span class="s2">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">concat</span><span class="s3">([</span><span class="s1">ARR</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">DEP</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]], </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">trainSchd </span><span class="s2">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">()</span>
    <span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;LOND-Dep&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">trainSummary</span><span class="s3">[</span><span class="s4">&quot;LOND (Station) (L) DEP&quot;</span><span class="s3">]</span>
    <span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;BIRM-Arr&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">trainSummary</span><span class="s3">[</span><span class="s4">&quot;BIRM (Station) (L) ARR&quot;</span><span class="s3">]</span>
    <span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Simulated Running Time&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;BIRM-Arr&quot;</span><span class="s3">] </span><span class="s2">- </span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;LOND-Dep&quot;</span><span class="s3">]</span>
    <span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Scheduled Running Time&quot;</span><span class="s3">] </span><span class="s2">=</span><span class="s1">dt</span><span class="s3">[</span><span class="s4">&quot;Running Time&quot;</span><span class="s3">].</span><span class="s1">sum</span><span class="s3">()</span>
    <span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Simulated Running Time&quot;</span><span class="s3">] </span><span class="s2">- </span><span class="s1">trainSchd</span><span class="s3">[</span><span class="s4">&quot;Scheduled Running Time&quot;</span><span class="s3">]</span>

    <span class="s2">return </span><span class="s1">trainSchd</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">blk </span><span class="s2">= </span><span class="s5">11</span>
<span class="s1">env </span><span class="s2">= </span><span class="s1">simpy</span><span class="s3">.</span><span class="s1">Environment</span><span class="s3">()</span>
<span class="s1">traS </span><span class="s2">= </span><span class="s1">schedule</span><span class="s3">(</span><span class="s1">blk</span><span class="s3">)</span>
<span class="s1">sch </span><span class="s2">= </span><span class="s1">traS</span><span class="s3">[[</span><span class="s4">&quot;LOND-Dep&quot;</span><span class="s3">,</span><span class="s4">&quot;BIRM-Arr&quot;</span><span class="s3">,</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">]]</span>
<span class="s1">sch</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">].</span><span class="s1">describe</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Delay distribution 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">plotWithPdf</span><span class="s3">(</span><span class="s1">sch</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">], </span><span class="s1">xmin</span><span class="s2">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">xmax</span><span class="s2">=</span><span class="s5">1500</span><span class="s3">, </span><span class="s1">bins</span><span class="s2">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1500</span><span class="s3">, </span><span class="s5">41</span><span class="s3">))</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">sch</span><span class="s3">[</span><span class="s4">&quot;LOND-Dep&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">sch</span><span class="s3">[</span><span class="s4">&quot;LOND-Dep&quot;</span><span class="s3">].</span><span class="s1">apply</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">time</span><span class="s3">.</span><span class="s1">strftime</span><span class="s3">(</span><span class="s4">'%H:%M:%S'</span><span class="s3">, </span><span class="s1">time</span><span class="s3">.</span><span class="s1">gmtime</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)))</span>
<span class="s1">sch</span><span class="s3">[</span><span class="s4">&quot;BIRM-Arr&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">sch</span><span class="s3">[</span><span class="s4">&quot;BIRM-Arr&quot;</span><span class="s3">].</span><span class="s1">apply</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">time</span><span class="s3">.</span><span class="s1">strftime</span><span class="s3">(</span><span class="s4">'%H:%M:%S'</span><span class="s3">, </span><span class="s1">time</span><span class="s3">.</span><span class="s1">gmtime</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)))</span>
<span class="s1">sch</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">] </span><span class="s2">= </span><span class="s1">sch</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">].</span><span class="s1">apply</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">time</span><span class="s3">.</span><span class="s1">strftime</span><span class="s3">(</span><span class="s4">'%H:%M:%S'</span><span class="s3">, </span><span class="s1">time</span><span class="s3">.</span><span class="s1">gmtime</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)))</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">sch</span><span class="s3">.</span><span class="s1">head</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Generating N, inter-arival time and delay time 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
<span class="s1">kList </span><span class="s2">= </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">,</span><span class="s5">15</span><span class="s3">)</span>
<span class="s1">n</span><span class="s2">=</span><span class="s1">len</span><span class="s3">(</span><span class="s1">kList</span><span class="s3">)</span>
<span class="s1">sdata </span><span class="s2">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">()</span>
<span class="s1">sdata</span><span class="s3">[</span><span class="s4">'K'</span><span class="s3">] </span><span class="s2">= </span><span class="s3">[</span><span class="s2">None</span><span class="s3">]</span><span class="s2">*</span><span class="s1">n</span>
<span class="s1">sdata</span><span class="s3">[</span><span class="s4">'N'</span><span class="s3">] </span><span class="s2">= </span><span class="s3">[</span><span class="s2">None</span><span class="s3">]</span><span class="s2">*</span><span class="s1">n</span>
<span class="s1">sdata</span><span class="s3">[</span><span class="s4">'Delay Time'</span><span class="s3">] </span><span class="s2">= </span><span class="s3">[</span><span class="s2">None</span><span class="s3">]</span><span class="s2">*</span><span class="s1">n</span>
<span class="s1">sdata</span><span class="s3">[</span><span class="s4">'BIRM-IARR'</span><span class="s3">] </span><span class="s2">= </span><span class="s3">[</span><span class="s2">None</span><span class="s3">]</span><span class="s2">*</span><span class="s1">n</span>

<span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s1">env </span><span class="s2">= </span><span class="s1">simpy</span><span class="s3">.</span><span class="s1">Environment</span><span class="s3">()</span>
    <span class="s1">n</span><span class="s3">, </span><span class="s1">delayTime</span><span class="s3">, </span><span class="s1">iarr </span><span class="s2">= </span><span class="s1">runLondBrim</span><span class="s3">(</span><span class="s1">kList</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s1">log</span><span class="s2">=False</span><span class="s3">)</span>
    
    <span class="s1">sdata</span><span class="s3">.</span><span class="s1">at</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s4">'K'</span><span class="s3">] </span><span class="s2">= </span><span class="s1">kList</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
    <span class="s1">sdata</span><span class="s3">.</span><span class="s1">at</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s4">'N'</span><span class="s3">] </span><span class="s2">= </span><span class="s1">n</span>
    <span class="s1">sdata</span><span class="s3">.</span><span class="s1">at</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s4">'Delay Time'</span><span class="s3">] </span><span class="s2">= </span><span class="s1">delayTime</span>
    <span class="s1">sdata</span><span class="s3">.</span><span class="s1">at</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s4">'BIRM-IARR'</span><span class="s3">] </span><span class="s2">= </span><span class="s1">iarr</span>
<span class="s1">sdata</span>
<hr class="ls0"><span class="s0">#%% 
</span>

<span class="s1">max </span><span class="s2">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">sdata</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s1">sdata</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">] </span><span class="s2">&lt;= </span><span class="s1">sdata</span><span class="s3">[</span><span class="s4">&quot;BIRM-IARR&quot;</span><span class="s3">]</span><span class="s2">/</span><span class="s5">2</span><span class="s3">][</span><span class="s4">&quot;N&quot;</span><span class="s3">].</span><span class="s1">max</span><span class="s3">())</span>
<span class="s1">sdata</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[(</span><span class="s1">sdata</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">] </span><span class="s2">&lt;= </span><span class="s1">sdata</span><span class="s3">[</span><span class="s4">&quot;BIRM-IARR&quot;</span><span class="s3">]</span><span class="s2">/</span><span class="s5">2</span><span class="s3">) </span><span class="s2">&amp; </span><span class="s3">(</span><span class="s1">sdata</span><span class="s3">[</span><span class="s4">&quot;N&quot;</span><span class="s3">] </span><span class="s2">== </span><span class="s1">max</span><span class="s3">)]</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">sdata</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[(</span><span class="s1">sdata</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">] </span><span class="s2">&lt;= </span><span class="s1">sdata</span><span class="s3">[</span><span class="s4">&quot;BIRM-IARR&quot;</span><span class="s3">]</span><span class="s2">/</span><span class="s5">2</span><span class="s3">) </span><span class="s2">&amp; </span><span class="s3">(</span><span class="s1">sdata</span><span class="s3">[</span><span class="s4">&quot;N&quot;</span><span class="s3">] </span><span class="s2">== </span><span class="s1">max</span><span class="s3">)][[</span><span class="s4">&quot;K&quot;</span><span class="s3">,</span><span class="s4">&quot;N&quot;</span><span class="s3">]]</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">blk </span><span class="s2">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">sdata</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[(</span><span class="s1">sdata</span><span class="s3">[</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">] </span><span class="s2">&lt;= </span><span class="s1">sdata</span><span class="s3">[</span><span class="s4">&quot;BIRM-IARR&quot;</span><span class="s3">]</span><span class="s2">/</span><span class="s5">2</span><span class="s3">) </span><span class="s2">&amp; </span><span class="s3">(</span><span class="s1">sdata</span><span class="s3">[</span><span class="s4">&quot;N&quot;</span><span class="s3">] </span><span class="s2">== </span><span class="s1">max</span><span class="s3">)][[</span><span class="s4">&quot;K&quot;</span><span class="s3">,</span><span class="s4">&quot;N&quot;</span><span class="s3">]][</span><span class="s4">&quot;K&quot;</span><span class="s3">])</span>
<span class="s1">blk</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Coefficient calculating 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">41</span><span class="s3">)</span>
<span class="s1">pd</span><span class="s3">.</span><span class="s1">options</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">.</span><span class="s1">chained_assignment </span><span class="s2">= None</span>
<span class="s1">target </span><span class="s2">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">sdata</span><span class="s3">[</span><span class="s4">'N'</span><span class="s3">])</span>
<span class="s1">predictor </span><span class="s2">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">sdata</span><span class="s3">[[</span><span class="s4">'BIRM-IARR'</span><span class="s3">, </span><span class="s4">'Delay Time'</span><span class="s3">,</span><span class="s4">'K'</span><span class="s3">]])</span>
<span class="s1">predictor </span><span class="s2">= </span><span class="s1">sm</span><span class="s3">.</span><span class="s1">add_constant</span><span class="s3">(</span><span class="s1">predictor</span><span class="s3">)</span>


<span class="s1">model </span><span class="s2">= </span><span class="s1">sm</span><span class="s3">.</span><span class="s1">OLS</span><span class="s3">(</span><span class="s1">target</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">float</span><span class="s3">), </span><span class="s1">predictor</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">float</span><span class="s3">)).</span><span class="s1">fit</span><span class="s3">()</span>
<span class="s1">predictions </span><span class="s2">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">predictor</span><span class="s3">)</span>
<span class="s1">model</span><span class="s3">.</span><span class="s1">summary</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Linear Programming optimisation 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">#### Using sklearn.linear_model.LinearRegression 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">objective </span><span class="s2">= </span><span class="s3">[</span><span class="s1">model</span><span class="s3">.</span><span class="s1">params</span><span class="s3">[</span><span class="s4">'const'</span><span class="s3">], </span><span class="s1">model</span><span class="s3">.</span><span class="s1">params</span><span class="s3">[</span><span class="s4">'K'</span><span class="s3">], </span><span class="s1">model</span><span class="s3">.</span><span class="s1">params</span><span class="s3">[</span><span class="s4">'Delay Time'</span><span class="s3">], </span><span class="s1">model</span><span class="s3">.</span><span class="s1">params</span><span class="s3">[</span><span class="s4">'BIRM-IARR'</span><span class="s3">]]</span>
<span class="s1">lhs_ineq </span><span class="s2">= </span><span class="s3">[[ </span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">1</span><span class="s3">,  </span><span class="s5">1</span><span class="s3">]]</span>
<span class="s1">rhs_ineq </span><span class="s2">= </span><span class="s3">[</span><span class="s5">0.5</span><span class="s3">]</span>
<span class="s1">bounds </span><span class="s2">= </span><span class="s3">[(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">),</span>
       <span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">15</span><span class="s3">),</span>
       <span class="s3">(</span><span class="s5">100</span><span class="s3">,</span><span class="s5">600</span><span class="s3">),</span>
       <span class="s3">(</span><span class="s5">260</span><span class="s3">, </span><span class="s5">1200</span><span class="s3">)]</span>
<span class="s1">lOptimise </span><span class="s2">= </span><span class="s1">linprog</span><span class="s3">(</span><span class="s1">c</span><span class="s2">=</span><span class="s1">objective</span><span class="s3">, </span><span class="s1">A_ub</span><span class="s2">=</span><span class="s1">lhs_ineq</span><span class="s3">, </span><span class="s1">b_ub</span><span class="s2">=</span><span class="s1">rhs_ineq</span><span class="s3">, </span><span class="s1">bounds </span><span class="s2">= </span><span class="s1">bounds</span><span class="s3">, </span><span class="s1">method</span><span class="s2">=</span><span class="s4">&quot;revised simplex&quot;</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">lOptimise</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">&lt;font color=blue&gt; 
     
- Max trains = 6 
- Blocks = 2 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">### Integer Programming optimisation 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">#### Using Pulp 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s1">x </span><span class="s2">= </span><span class="s1">pulp</span><span class="s3">.</span><span class="s1">LpVariable</span><span class="s3">(</span><span class="s4">&quot;BIRM-IARR&quot;</span><span class="s3">, </span><span class="s1">lowBound </span><span class="s2">= </span><span class="s5">260</span><span class="s3">, </span><span class="s1">upBound</span><span class="s2">=</span><span class="s5">1200</span><span class="s3">)</span>
<span class="s1">y </span><span class="s2">= </span><span class="s1">pulp</span><span class="s3">.</span><span class="s1">LpVariable</span><span class="s3">(</span><span class="s4">&quot;Delay Time&quot;</span><span class="s3">, </span><span class="s1">lowBound </span><span class="s2">= </span><span class="s5">100</span><span class="s3">, </span><span class="s1">upBound</span><span class="s2">=</span><span class="s5">600</span><span class="s3">)</span>
<span class="s1">z </span><span class="s2">= </span><span class="s1">pulp</span><span class="s3">.</span><span class="s1">LpVariable</span><span class="s3">(</span><span class="s4">&quot;K&quot;</span><span class="s3">, </span><span class="s1">lowBound </span><span class="s2">= </span><span class="s5">2</span><span class="s3">, </span><span class="s1">upBound</span><span class="s2">=</span><span class="s5">15</span><span class="s3">, </span><span class="s1">cat</span><span class="s2">=</span><span class="s1">pulp</span><span class="s3">.</span><span class="s1">LpInteger</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">prob </span><span class="s2">= </span><span class="s1">pulp</span><span class="s3">.</span><span class="s1">LpProblem</span><span class="s3">(</span><span class="s4">'Problem'</span><span class="s3">, </span><span class="s1">pulp</span><span class="s3">.</span><span class="s1">LpMaximize</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">prob</span><span class="s2">+=</span><span class="s1">model</span><span class="s3">.</span><span class="s1">params</span><span class="s3">[</span><span class="s4">'const'</span><span class="s3">] </span><span class="s2">+ </span><span class="s1">model</span><span class="s3">.</span><span class="s1">params</span><span class="s3">[</span><span class="s4">'K'</span><span class="s3">]</span><span class="s2">*</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">model</span><span class="s3">.</span><span class="s1">params</span><span class="s3">[</span><span class="s4">'Delay Time'</span><span class="s3">]</span><span class="s2">*</span><span class="s1">y </span><span class="s2">+ </span><span class="s1">model</span><span class="s3">.</span><span class="s1">params</span><span class="s3">[</span><span class="s4">'BIRM-IARR'</span><span class="s3">]</span><span class="s2">*</span><span class="s1">y</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">prob</span><span class="s2">+= </span><span class="s1">y</span><span class="s2">&lt;= </span><span class="s3">(</span><span class="s5">1</span><span class="s2">/</span><span class="s5">2</span><span class="s3">)</span><span class="s2">*</span><span class="s1">x</span>
<span class="s1">prob</span><span class="s2">+= </span><span class="s1">z</span><span class="s2">&gt;= </span><span class="s5">2</span>
<span class="s1">prob</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">status </span><span class="s2">= </span><span class="s1">prob</span><span class="s3">.</span><span class="s1">solve</span><span class="s3">()</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">pulp</span><span class="s3">.</span><span class="s1">LpStatus</span><span class="s3">[</span><span class="s1">status</span><span class="s3">]</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">prob</span><span class="s3">.</span><span class="s1">objective</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">int</span><span class="s3">(</span><span class="s1">pulp</span><span class="s3">.</span><span class="s1">value</span><span class="s3">(</span><span class="s1">prob</span><span class="s3">.</span><span class="s1">objective</span><span class="s3">)</span><span class="s2">//</span><span class="s5">1</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">pulp</span><span class="s3">.</span><span class="s1">value</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s0">### Monte Carlo</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">pulp</span><span class="s3">.</span><span class="s1">LpStatus</span><span class="s3">[</span><span class="s1">status</span><span class="s3">]</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">pulp</span><span class="s3">.</span><span class="s1">LpStatus</span><span class="s3">[</span><span class="s1">status</span><span class="s3">]</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">prob</span><span class="s3">.</span><span class="s1">objective</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">int</span><span class="s3">(</span><span class="s1">pulp</span><span class="s3">.</span><span class="s1">value</span><span class="s3">(</span><span class="s1">prob</span><span class="s3">.</span><span class="s1">objective</span><span class="s3">)</span><span class="s2">//</span><span class="s5">1</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">pulp</span><span class="s3">.</span><span class="s1">value</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s0">### Monte Carlo</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">pulp</span><span class="s3">.</span><span class="s1">LpStatus</span><span class="s3">[</span><span class="s1">status</span><span class="s3">]</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">prob</span><span class="s3">.</span><span class="s1">objective</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">int</span><span class="s3">(</span><span class="s1">pulp</span><span class="s3">.</span><span class="s1">value</span><span class="s3">(</span><span class="s1">prob</span><span class="s3">.</span><span class="s1">objective</span><span class="s3">)</span><span class="s2">//</span><span class="s5">1</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">pulp</span><span class="s3">.</span><span class="s1">value</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">### Monte Carlo 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">#### Loss function 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">,</span><span class="s1">y</span><span class="s3">,</span><span class="s1">z</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s2">return </span><span class="s1">model</span><span class="s3">.</span><span class="s1">params</span><span class="s3">[</span><span class="s4">'const'</span><span class="s3">] </span><span class="s2">+ </span><span class="s1">model</span><span class="s3">.</span><span class="s1">params</span><span class="s3">[</span><span class="s4">'K'</span><span class="s3">]</span><span class="s2">*</span><span class="s1">x </span><span class="s2">+ </span><span class="s1">model</span><span class="s3">.</span><span class="s1">params</span><span class="s3">[</span><span class="s4">'Delay Time'</span><span class="s3">]</span><span class="s2">*</span><span class="s1">y </span><span class="s2">+ </span><span class="s1">model</span><span class="s3">.</span><span class="s1">params</span><span class="s3">[</span><span class="s4">'BIRM-IARR'</span><span class="s3">]</span><span class="s2">*</span><span class="s1">y</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">####  Monte Carlo Optimisation 
 <hr class="ls0"></span><span class="s0">#%% 
</span>
<span class="s2">def </span><span class="s1">monte_carlo</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">xmin</span><span class="s2">=</span><span class="s5">4</span><span class="s3">, </span><span class="s1">xmax</span><span class="s2">=</span><span class="s5">11</span><span class="s3">, </span><span class="s1">ymin</span><span class="s2">=</span><span class="s5">120</span><span class="s3">, </span><span class="s1">ymax</span><span class="s2">=</span><span class="s5">300</span><span class="s3">, </span><span class="s1">zmin </span><span class="s2">= </span><span class="s5">300</span><span class="s3">, </span><span class="s1">zmax </span><span class="s2">= </span><span class="s5">600</span><span class="s3">)</span><span class="s2">:</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s1">xmin</span><span class="s3">, </span><span class="s1">xmax</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)]</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s1">ymin</span><span class="s3">, </span><span class="s1">ymax</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)]</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s1">zmin</span><span class="s3">, </span><span class="s1">zmax</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)]</span>
    <span class="s1">xp </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">x</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] ]</span>
    <span class="s1">yp </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">y</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] ]</span>
    <span class="s1">zp </span><span class="s2">= </span><span class="s3">[ </span><span class="s1">z</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] ]</span>
    <span class="s1">fmax </span><span class="s2">= </span><span class="s1">f</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">yp</span><span class="s3">[</span><span class="s5">0</span><span class="s3">],</span><span class="s1">zp</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
   
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span><span class="s2">:</span>
        <span class="s2">if </span><span class="s1">y</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] </span><span class="s2">&lt;= </span><span class="s1">z</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span><span class="s2">/</span><span class="s5">2</span><span class="s2">:</span>
            <span class="s1">fi </span><span class="s2">= </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">i</span><span class="s3">],</span><span class="s1">z</span><span class="s3">[</span><span class="s1">i</span><span class="s3">])</span>
       
            <span class="s2">if </span><span class="s1">fi </span><span class="s2">&gt; </span><span class="s1">fmax</span><span class="s2">:</span>
                <span class="s1">xp </span><span class="s2">+= </span><span class="s3">[</span><span class="s1">x</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]]</span>
                <span class="s1">yp </span><span class="s2">+= </span><span class="s3">[</span><span class="s1">y</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]]</span>
                <span class="s1">zp </span><span class="s2">+= </span><span class="s3">[</span><span class="s1">z</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]]</span>
                <span class="s1">fmax </span><span class="s2">= </span><span class="s1">fi</span>

    <span class="s1">xs </span><span class="s2">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s1">xmin</span><span class="s3">, </span><span class="s1">xmax</span><span class="s3">, </span><span class="s5">100</span><span class="s3">)</span>
    <span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s1">ymin</span><span class="s3">, </span><span class="s1">ymax</span><span class="s3">, </span><span class="s5">100</span><span class="s3">)</span>
    <span class="s1">zs </span><span class="s2">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s1">zmin</span><span class="s3">, </span><span class="s1">zmax</span><span class="s3">, </span><span class="s5">100</span><span class="s3">)</span>
    <span class="s1">xx</span><span class="s3">, </span><span class="s1">yy</span><span class="s3">, </span><span class="s1">zz </span><span class="s2">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">xs</span><span class="s3">, </span><span class="s1">ys</span><span class="s3">, </span><span class="s1">zs</span><span class="s3">)</span>
    <span class="s1">t</span><span class="s2">=</span><span class="s1">f</span><span class="s3">(</span><span class="s1">xx</span><span class="s3">, </span><span class="s1">yy</span><span class="s3">, </span><span class="s1">zz</span><span class="s3">)</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">t</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">((</span><span class="s2">-</span><span class="s5">1</span><span class="s3">,</span><span class="s5">100</span><span class="s3">))</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">t</span><span class="s3">[</span><span class="s2">:</span><span class="s5">100</span><span class="s3">,</span><span class="s2">:</span><span class="s3">]</span>
    <span class="s1">fig</span><span class="s3">, </span><span class="s1">ax</span><span class="s2">= </span><span class="s1">plt</span><span class="s3">.</span><span class="s1">subplots</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">fig</span><span class="s3">.</span><span class="s1">set_figwidth</span><span class="s3">(</span><span class="s5">6</span><span class="s3">)</span>
    <span class="s1">fig</span><span class="s3">.</span><span class="s1">set_figheight</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
    <span class="s1">cs </span><span class="s2">= </span><span class="s1">ax</span><span class="s3">.</span><span class="s1">contour</span><span class="s3">(</span><span class="s1">xs</span><span class="s3">, </span><span class="s1">ys</span><span class="s3">,</span><span class="s1">t</span><span class="s3">,</span><span class="s5">100</span><span class="s3">)</span>
    <span class="s1">fig</span><span class="s3">.</span><span class="s1">colorbar</span><span class="s3">(</span><span class="s1">cs</span><span class="s3">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax</span><span class="s3">)</span>

       
    <span class="s1">plt</span><span class="s3">.</span><span class="s1">scatter</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">'red'</span><span class="s3">, </span><span class="s1">marker</span><span class="s2">=</span><span class="s4">'.'</span><span class="s3">)</span>
    <span class="s1">plt</span><span class="s3">.</span><span class="s1">plot</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">, </span><span class="s1">yp</span><span class="s3">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">'red'</span><span class="s3">)</span>
    <span class="s1">plt</span><span class="s3">.</span><span class="s1">title</span><span class="s3">(</span><span class="s4">f&quot;(K, Delay Time, IAAR, N) = </span><span class="s6">{</span><span class="s1">xp</span><span class="s3">[</span><span class="s2">-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">yp</span><span class="s3">[</span><span class="s2">-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">zp</span><span class="s3">[</span><span class="s2">-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">int</span><span class="s3">(</span><span class="s1">f</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">[</span><span class="s2">-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">yp</span><span class="s3">[</span><span class="s2">-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">zp</span><span class="s3">[</span><span class="s2">-</span><span class="s5">1</span><span class="s3">]))</span><span class="s6">}</span><span class="s4">&quot;</span><span class="s3">)</span>
       
    <span class="s2">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">), </span><span class="s1">xp</span><span class="s3">[</span><span class="s2">-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">yp</span><span class="s3">[</span><span class="s2">-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">zp</span><span class="s3">[</span><span class="s2">-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">int</span><span class="s3">(</span><span class="s1">f</span><span class="s3">(</span><span class="s1">xp</span><span class="s3">[</span><span class="s2">-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">yp</span><span class="s3">[</span><span class="s2">-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">zp</span><span class="s3">[</span><span class="s2">-</span><span class="s5">1</span><span class="s3">]))</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
<span class="s1">monte_carlo</span><span class="s3">(</span><span class="s5">40</span><span class="s3">)</span>
<hr class="ls0"><span class="s0">#%% 
</span>
<span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
<span class="s1">_</span><span class="s3">,</span><span class="s1">oK</span><span class="s3">,</span><span class="s1">oDelay</span><span class="s3">,</span><span class="s1">oIARR</span><span class="s3">,</span><span class="s1">oN </span><span class="s2">= </span><span class="s1">monte_carlo</span><span class="s3">(</span><span class="s5">1000</span><span class="s3">)</span>
<span class="s1">_</span><span class="s3">,</span><span class="s1">oK</span><span class="s3">,</span><span class="s1">oDelay</span><span class="s3">,</span><span class="s1">oIARR</span><span class="s3">,</span><span class="s1">oN</span>
<hr class="ls0"><span class="s0">#%% md 
</span>
<span class="s1">&lt;font color=blue&gt; 
     
- Max trains = 9 
- Blocks = 11 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">## Conclusion 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">&lt;font color=blue&gt; 
 
Overall, from simulation and optimisation, the best results are optimised using Monte Carlo and details are below for a track: 
- Max trains per hour = 9 
- With Block = 11 
     
Given that the average delay time should not be higher than half the scheduled time between consecutive trains. 
 <hr class="ls0"></span><span class="s0">#%% md 
</span>
<span class="s1">## References 
 
[1] Yuxiang Yang, Ping Huang, Qiyuan Peng, Jie Li, Chao Wen: Statistical delay distribution analysis on high-speed railway trains. J. Mod. Transport. (2019) 27(3):188–197 https://link.springer.com/content/pdf/10.1007/s40534-019-0188-z.pdf 
</span></pre>
</body>
</html>